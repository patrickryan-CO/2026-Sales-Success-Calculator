<script>
    tailwind.config = {
        theme: {
            extend: {
                colors: {
                    'primary': '#0063a3',      // Trimble primary blue
                    'accent': '#fbad26',       // Trimble accent orange/amber
                    'primary-text': '#252a2e', // Trimble primary dark text
                    'system-bg': '#f3f6f9',    // Light background for conversation box
                },
                fontFamily: {
                    'sans': ['Open Sans', 'sans-serif'] // Set default font
                }
            }
        }
    }
</script>

<script src="https://cdn.tailwindcss.com"></script>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
    /* Set base font and text color */
    body {
        font-family: 'Open Sans', sans-serif;
        color: #252a2e; /* primary-text */
    }
    
    /* Wizard Container & Conversational Style */
    .wizard-container {
        /* Mobile First: Tight Padding, Smaller Max Width */
        max-width: 100%;
        margin-left: 0.5rem;
        margin-right: 0.5rem;
        padding: 1rem; /* p-4 on mobile */
        background-color: #ffffff;
        border-radius: 0.5rem; /* rounded-lg */
        box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1); 
        margin-top: 1rem;
        margin-bottom: 1rem;
    }
    /* Larger Screens: Restore original size */
    @media (min-width: 768px) {
        .wizard-container {
            max-width: 48rem; /* Equivalent to max-w-4xl */
            margin-left: auto;
            margin-right: auto;
            padding: 2.5rem; /* p-10 */
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            margin-top: 3rem;
            margin-bottom: 3rem;
        }
    }

    .conversation-bubble {
        background-color: #f3f6f9; /* system-bg */
        border: 1px solid #e5e7eb;
        padding: 1rem; /* Reduced padding for mobile */
        margin-bottom: 1.5rem;
        border-radius: 0.5rem;
        font-size: 0.95rem; /* Smaller text on mobile */
        line-height: 1.5;
    }
    @media (min-width: 768px) {
        .conversation-bubble {
            padding: 1.5rem;
            font-size: 1.05rem;
            line-height: 1.6;
            margin-bottom: 2rem;
        }
    }

    .conversation-bubble strong {
        color: #0063a3; /* primary */
        font-weight: 700;
    }

    /* Input Styling (Retained from base code) */
    .input-label {
        display: block;
        font-size: 0.875rem;
        font-weight: 600;
        color: #252a2e;
        margin-bottom: 0.25rem;
    }
    
    .input-field {
        display: block;
        width: 100%;
        border-radius: 0.375rem;
        border: 1px solid #D1D5DB;
        padding: 0.5rem 0.75rem;
        box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        color: #252a2e;
        font-family: 'Open Sans', sans-serif;
    }
    .input-field:focus {
        outline: 2px solid transparent;
        outline-offset: 2px;
        border-color: #0063a3;
        box-shadow: 0 0 0 2px rgba(0, 99, 163, 0.3);
    }
    
    /* Validation Error Style */
    .input-field.error {
        border-color: #B91C1C; /* border-red-700 */
        box-shadow: 0 0 0 2px rgba(185, 28, 28, 0.3);
    }
    .error-message {
        color: #B91C1C;
        font-size: 0.75rem; /* text-xs */
        margin-top: 0.25rem;
    }
    
    /* Calculation & Results Boxes */
    .calc-box {
        background-color: #F9FAFB;
        border: 1px solid #E5E7EB;
        border-radius: 0.5rem;
        padding: 0.75rem; /* Reduced padding for mobile */
    }
    
    .calc-output {
        display: block;
        font-size: 1.5rem; /* Smaller font for mobile */
        font-weight: 700;
        color: #0063a3;
        margin-top: 0.25rem;
    }
    @media (min-width: 768px) {
        .calc-output {
            font-size: 1.875rem;
        }
    }

    /* Slider Styles (Retained) */
    input[type=range] {
        -webkit-appearance: none;
        width: 100%;
        height: 8px;
        border-radius: 5px;
        background: #d3d3d3;
        outline: none;
        opacity: 0.9;
        -webkit-transition: .2s;
        transition: opacity .2s;
        margin-top: 1rem;
        margin-bottom: 0.5rem;
    }
    input[type=range]::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: #0063a3;
        cursor: pointer;
        box-shadow: 0 0 5px rgba(0,0,0,0.2);
    }
    /* Hide number input arrows (Retained) */
    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }
    input[type=number] {
        -moz-appearance: textfield;
    }
    
    /* Navigation Buttons (Optimized for Mobile) */
    .nav-button-group {
        display: flex;
        gap: 0.5rem; /* Reduced gap */
        flex-wrap: wrap; /* Allow wrapping if necessary */
        justify-content: flex-end;
    }

    .nav-button {
        display: inline-block;
        padding: 0.5rem 1rem; /* Reduced padding for mobile */
        border-radius: 0.375rem;
        font-size: 0.8rem; /* Smaller font on mobile */
        font-weight: 600;
        text-align: center;
        border: 1px solid transparent;
        transition: all 0.2s;
        cursor: pointer;
        white-space: nowrap; /* Prevent buttons from splitting words */
    }
    @media (min-width: 768px) {
        .nav-button {
            padding: 0.625rem 1.25rem;
            font-size: 0.875rem;
        }
    }

    .nav-button-primary {
        background-color: #0063a3;
        color: #FFFFFF;
    }
    .nav-button-primary:hover {
        background-color: #004a7c;
    }
    .nav-button-primary:disabled {
        background-color: #D1D5DB;
        cursor: not-allowed;
    }
    .nav-button-default {
        background-color: #E5E7EB;
        color: #252a2e;
    }
    .nav-button-default:hover {
        background-color: #D1D5DB;
    }
    
    /* Tooltip Styles (Retained) */
    .tooltip-trigger {
        position: relative;
        display: inline-block;
        width: 1rem;
        height: 1rem;
        line-height: 1rem;
        margin-left: 0.25rem;
        background-color: #D1D5DB;
        color: #ffffff;
        font-weight: 700;
        font-style: italic;
        font-family: 'Georgia', serif;
        font-size: 0.8rem;
        text-align: center;
        border-radius: 50%;
        cursor: help;
        user-select: none;
        -webkit-user-select: none;
    }
    .tooltip-trigger::after {
        content: attr(data-tooltip);
        position: absolute;
        bottom: 125%;
        left: 50%;
        transform: translateX(-50%);
        background-color: #252a2e;
        color: #FFFFFF;
        font-family: 'Open Sans', sans-serif;
        font-style: normal;
        font-size: 0.875rem;
        font-weight: 500;
        padding: 0.5rem 0.75rem;
        border-radius: 0.375rem;
        box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.2s, visibility 0.2s;
        width: 250px;
        z-index: 10;
        pointer-events: none;
    }
    .tooltip-trigger:hover::after {
        opacity: 1;
        visibility: visible;
    }
    
    /* Print styles (Retained) */
    @media print {
        body { background-color: white !important; color: #252a2e !important; }
        .wizard-container { box-shadow: none !important; margin: 0 !important; padding: 0 !important; width: 100% !important; max-width: 100% !important; }
        #navigation-buttons, #progress-bar-container, .conversation-bubble, .error-message, .tooltip-trigger { display: none !important; }
        .step-heading { margin-top: 2rem; page-break-before: auto; page-break-inside: avoid; }
        .form-group, .hidden-step-content { display: block !important; visibility: visible !important; }
        input, select, textarea { border: 1px solid #ccc !important; }
        /* Show the entire content, regardless of JS visibility status */
        #form-fields > div { display: block !important; }
        .calc-output { color: #000 !important; } /* Black text for print */
        /* Show tooltip content in print */
        .tooltip-trigger::after { content: " (" attr(data-tooltip) ")"; position: static; transform: none; background-color: transparent; color: #4B5563; font-style: normal; font-size: 0.8rem; padding: 0; margin: 0; margin-left: 2px; box-shadow: none; opacity: 1; visibility: visible; width: auto; display: inline; }
    }
</style>

<div class="bg-gray-100" style="font-family: 'Open Sans', sans-serif;">
    <div class="wizard-container">
        <header class="mb-6 text-center space-y-2">
            <h1 id="main-heading" class="text-2xl md:text-3xl font-bold text-primary">The Trimble 2026 Success Plan</h1>
            <p class="text-base md:text-lg font-semibold text-primary-text">Personal Commitment Wizard (V2)</p>
            <p class="text-sm text-primary-text italic">PEOPLE, PIPELINE & PRODUCTIVITY</p>
        </header>

        <form id="skoForm" onsubmit="return false;">

            <div id="conversation-bubble" class="conversation-bubble">
                </div>
            
            <div id="hidden-step-content" style="display: none;">
                <input type="number" id="meetingsImpliedWinRate" value="0">
            </div>

            <div id="form-fields" class="space-y-6">

                <div class="form-group" id="group-intro"></div>

                <div class="form-group" id="group-personName">
                    <label for="personName" class="input-label">My Full Name:</label>
                    <input type="text" id="personName" class="input-field required-field" placeholder="e.g., Jane Doe">
                    <span id="error-personName" class="error-message hidden">Your name is required.</span>
                </div>

                <div class="form-group" id="group-managerName">
                    <label for="managerName" class="input-label">My Manager's Name:</label>
                    <input type="text" id="managerName" class="input-field required-field" placeholder="e.g., John Smith">
                    <span id="error-managerName" class="error-message hidden">Your manager's name is required.</span>
                </div>

                <div class="form-group" id="group-region">
                    <label for="region" class="input-label">My Region:</label>
                    <select id="region" class="input-field required-field">
                        <option value="" disabled selected>Select your region</option>
                        <option value="NA">NA (North America)</option>
                        <option value="EMEA">EMEA</option>
                        <option value="APAC">APAC</option>
                    </select>
                    <span id="error-region" class="error-message hidden">Region selection is required.</span>
                </div>

                <div class="form-group" id="group-quota2025">
                    <label for="quota2025" class="input-label">My 2025 Quota ($):</label>
                    <input type="text" id="quota2025" class="input-field required-field numeric-field" placeholder="e.g., 1,000,000">
                    <span id="error-quota2025" class="error-message hidden">Valid quota amount is required.</span>
                </div>
                
                <div class="form-group" id="group-bookings2025">
                    <label for="bookings2025" class="input-label">My 2025 Bookings ($):</label>
                    <input type="text" id="bookings2025" class="input-field required-field numeric-field" placeholder="e.g., 1,100,000">
                    <span id="error-bookings2025" class="error-message hidden">Valid bookings amount is required.</span>
                    <div class="calc-box mt-4">
                        <span class="text-sm font-medium text-gray-700">Calculated 2025 Attainment:</span>
                        <span id="attainment2025" class="calc-output">0%</span>
                    </div>
                </div>
                
                <div class="form-group" id="group-winRate2025">
                    <label for="winRate2025" class="input-label">My 2025 Baseline Win Rate (%):</label>
                    <div class="relative">
                        <span class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-500">%</span>
                        <input type="number" id="winRate2025" class="input-field required-field pr-7" placeholder="e.g., 25">
                    </div>
                    <span id="error-winRate2025" class="error-message hidden">Valid win rate is required (0-100).</span>
                </div>

                <div class="form-group" id="group-avgDealSize2025">
                    <label for="avgDealSize2025" class="input-label">My 2025 Avg. Deal Size ($):</label>
                    <input type="text" id="avgDealSize2025" class="input-field required-field numeric-field" placeholder="e.g., 50,000">
                    <span id="error-avgDealSize2025" class="error-message hidden">Valid average deal size is required.</span>
                </div>
                
                <div class="form-group" id="group-avgMeetings2025">
                    <label for="avgMeetings2025" class="input-label">My 2025 Avg. In-Person Meetings (Quarterly):</label>
                    <input type="number" id="avgMeetings2025" class="input-field required-field" placeholder="e.g., 15">
                    <span id="error-avgMeetings2025" class="error-message hidden">Average meetings number is required.</span>
                </div>
                
                <div class="form-group" id="group-quota2026">
                    <label for="quota2026" class="input-label">My 2026 Quota Commitment ($):</label>
                    <input type="text" id="quota2026" class="input-field required-field numeric-field" placeholder="e.g., 1,200,000">
                    <span id="error-quota2026" class="error-message hidden">2026 Quota is required.</span>
                    
                    <div class="calc-box mt-6">
                        <span class="text-sm font-medium text-gray-700">Required Pipeline (at 2025 efficiency):</span>
                        <span id="pipelineToClose2026" class="calc-output">0</span>
                        <span class="text-xs text-gray-500">Based on Quota / 2025 Win Rate</span>
                    </div>
                    <div class="calc-box mt-4">
                        <span class="text-sm font-medium text-gray-700">Required Deals (at 2025 efficiency):</span>
                        <span id="dealsToClose2026" class="calc-output">0</span>
                        <span class="text-xs text-gray-500">Based on Required Pipeline / 2025 Avg. Deal Size</span>
                    </div>
                </div>

                <div class="form-group" id="group-reflection">
                    <label class="input-label">My Reflection (Based on the calculated numbers, does my 2026 goal feel achievable?):</label>
                    <div class="flex flex-wrap gap-x-6 gap-y-2 mt-2">
                        <div class="flex items-center">
                            <input id="reflect-1" name="reflection" type="radio" value="Achievable" class="focus:ring-primary h-4 w-4 text-primary border-gray-300 required-radio">
                            <label for="reflect-1" class="ml-2 block text-sm text-primary-text">Achievable</label>
                        </div>
                        <div class="flex items-center">
                            <input id="reflect-2" name="reflection" type="radio" value="Challenging" class="focus:ring-primary h-4 w-4 text-primary border-gray-300 required-radio">
                            <label for="reflect-2" class="ml-2 block text-sm text-primary-text">Challenging</label>
                        </div>
                        <div class="flex items-center">
                            <input id="reflect-3" name="reflection" type="radio" value="Impossible" class="focus:ring-primary h-4 w-4 text-primary border-gray-300 required-radio">
                            <label for="reflect-3" class="ml-2 block text-sm text-primary-text">Impossible</label>
                        </div>
                    </div>
                    <span id="error-reflection" class="error-message hidden">Please select an assessment of the goal.</span>
                </div>
                
                <div class="form-group" id="group-winRateImprovement">
                    <div class="space-y-4 p-6 rounded-lg bg-primary/10 border border-primary/20">
                        <h3 class="text-xl font-semibold text-primary">Lever 1: Improve Win Rate (Quality)</h3>
                        <label for="winRateImprovement" class="block text-sm font-medium text-primary-text">
                            Commit to improving Win Rate by: <span id="winRateImprovementLabel" class="font-bold text-primary">5.0%</span>
                            <br>(New Target Win Rate: <span id="newWinRateLabel" class="font-bold">0%</span>)
                        </label>
                        <input type="range" id="winRateImprovement" min="0" max="25" value="5" step="0.5" class="w-full">
                        
                        <div class="bg-white p-4 rounded-xl border border-primary/20 text-center">
                            <label class="text-sm font-medium text-primary-text">New Pipeline Needed</label>
                            <p id="newPipelineNeeded" class="text-2xl font-extrabold text-primary mt-1">0</p>
                        </div>
                    </div>
                </div>

                <div class="form-group" id="group-dealSizeImprovement">
                    <div class="space-y-4 p-6 rounded-lg bg-gray-100 border border-gray-300">
                        <h3 class="text-xl font-semibold text-primary-text">Lever 2: Improve Avg. Deal Size (Value)</h3>
                        <label for="dealSizeImprovement" class="block text-sm font-medium text-primary-text">
                            Commit to improving Avg. Deal Size by: <span id="dealSizeImprovementLabel" class="font-bold text-primary-text">15%</span>
                            <br>(New Target Deal Size: <span id="newAvgDealSizeLabel" class="font-bold">0</span>)
                        </label>
                        <input type="range" id="dealSizeImprovement" min="0" max="50" value="15" step="1" class="w-full" style="--thumb-color: #252a2e;">
                        
                        <div class="bg-white p-4 rounded-xl border border-gray-300 text-center">
                            <label class="text-sm font-medium text-primary-text">New Deals Needed</label>
                            <p id="newDealsNeeded" class="text-2xl font-extrabold text-primary-text mt-1">0</p>
                        </div>
                    </div>
                </div>
                
                <div class="form-group" id="group-meetingImprovement">
                    <div class="space-y-4 p-6 rounded-lg bg-gray-100 border border-gray-300">
                        <h3 class="text-xl font-semibold text-primary-text">Lever 3: Increase Meetings (Activity)</h3>
                        <p class="text-sm text-primary-text/80">Context: More face-time = more predictable deals.</p>
                        
                        <label for="meetingImprovement" class="block text-sm font-medium text-primary-text">
                            Commit to increasing Avg. Quarterly Meetings by: <span id="meetingImprovementLabel" class="font-bold text-primary-text">5</span>
                            <br>(New Quarterly Avg: <span id="newMeetingAvgLabel" class="font-bold">0</span>)
                        </label>
                        <input type="range" id="meetingImprovement" min="0" max="20" value="5" step="1" class="w-full" style="--thumb-color: #252a2e;">
                        
                        <label for="meetingsImpliedWinRate_visible" class="block text-sm font-medium text-primary-text mt-4">
                            My Implied New Win Rate (%):
                        </label>
                        <div class="relative">
                            <span class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-500">%</span>
                            <input type="number" id="meetingsImpliedWinRate_visible" class="input-field pr-7" placeholder="e.g., 28" data-sync-id="meetingsImpliedWinRate">
                        </div>
                        <span id="error-meetingsImpliedWinRate_visible" class="error-message hidden">A valid Win Rate is required for this lever.</span>

                        <div class="bg-white p-4 rounded-xl border border-gray-300 text-center">
                            <label class="text-sm font-medium text-primary-text">Implied Pipeline Needed</label>
                            <p id="meetingsPipelineNeeded" class="text-2xl font-extrabold text-primary-text mt-1">0</p>
                        </div>
                    </div>
                </div>

                <div class="form-group" id="group-primaryGoal">
                    <label class="input-label !font-semibold !text-base !text-primary-text">My Primary Goal (The Lever I will focus on):</label>
                    <div class="flex flex-wrap gap-x-6 gap-y-2 mt-2">
                        <div class="flex items-center">
                            <input id="goal-win-rate" name="primaryGoal" type="radio" value="Win Rate" class="focus:ring-primary h-4 w-4 text-primary border-gray-300 required-radio">
                            <label for="goal-win-rate" class="ml-2 block text-sm text-primary-text">Win Rate (L1)</label>
                        </div>
                        <div class="flex items-center">
                            <input id="goal-deal-size" name="primaryGoal" type="radio" value="Avg. Deal Size" class="focus:ring-primary h-4 w-4 text-primary border-gray-300 required-radio">
                            <label for="goal-deal-size" class="ml-2 block text-sm text-primary-text">Avg. Deal Size (L2)</label>
                        </div>
                        <div class="flex items-center">
                            <input id="goal-meetings" name="primaryGoal" type="radio" value="In-Person Meetings" class="focus:ring-primary h-4 w-4 text-primary border-gray-300 required-radio">
                            <label for="goal-meetings" class="ml-2 block text-sm text-primary-text">In-Person Meetings (L3)</label>
                        </div>
                        <div class="flex items-center">
                            <input id="goal-both" name="primaryGoal" type="radio" value="Both (L1 & L2)" class="focus:ring-primary h-4 w-4 text-primary border-gray-300 required-radio">
                            <label for="goal-both" class="ml-2 block text-sm text-primary-text">Both (L1 & L2)</label>
                        </div>
                        <div class="flex items-center">
                            <input id="goal-all-three" name="primaryGoal" type="radio" value="All Three Levers" class="focus:ring-primary h-4 w-4 text-primary border-gray-300 required-radio">
                            <label for="goal-all-three" class="ml-2 block text-sm text-primary-text">All Three Levers</label>
                        </div>
                    </div>
                    <span id="error-primaryGoal" class="error-message hidden">A primary goal is required.</span>
                </div>

                <div class="form-group" id="group-action-people">
                    <label class="input-label">Action: Focus on <strong>People</strong> (Training, Coaching, Skill-building):</label>
                    <input type="text" id="action-people" class="input-field required-field" placeholder="e.g., I will complete PIC certification by Q2, or I will 'murder-board' my deals with my manager...">
                    <span id="error-action-people" class="error-message hidden">People action is required.</span>
                </div>
                
                <div class="form-group" id="group-action-pipeline">
                    <label class="input-label">Action: Focus on <strong>Pipeline</strong> (Qualification, Prospecting, Deal Flow):</label>
                    <input type="text" id="action-pipeline" class="input-field required-field" placeholder="e.g., I will disqualify 20% more deals before the demo stage, or I will run one targeted outreach campaign per month...">
                    <span id="error-action-pipeline" class="error-message hidden">Pipeline action is required.</span>
                </div>

                <div class="form-group" id="group-action-productivity">
                    <label class="input-label">Action: Focus on <strong>Productivity</strong> (Tech Stack Use, Time Management):</label>
                    <input type="text" id="action-productivity" class="input-field required-field" placeholder="e.g., I will block 2 hours on my calendar every Friday for administrative tasks, or I will utilize the pricing tool for all deals under $15k...">
                    <span id="error-action-productivity" class="error-message hidden">Productivity action is required.</span>
                </div>

                <div class="form-group" id="group-action-forecast">
                    <label class="input-label">Key Action: Forecasting Commitment (How will you ensure 95-105% accuracy?)</label>
                    <input type="text" id="action-forecast" class="input-field required-field" placeholder="e.g., I will 'murder-board' my own commit list before submitting my forecast...">
                    <span id="error-action-forecast" class="error-message hidden">Forecasting action is required.</span>
                </div>

                <div class="form-group" id="group-action-account-plan">
                    <label class="input-label">Personal Improvement: Account Planning Action:</label>
                    <input type="text" id="action-account-plan" class="input-field required-field" placeholder="e.g., I will create a 4-quarter plan for my Top 10 accounts...">
                    <span id="error-action-account-plan" class="error-message hidden">Account planning action is required.</span>
                </div>

                <div class="form-group" id="group-action-cross-sell">
                    <label class="input-label">Personal Improvement: Cross Selling Action:</label>
                    <input type="text" id="action-cross-sell" class="input-field required-field" placeholder="e.g., I will identify 2 cross-sell opportunities in my Top 10 accounts...">
                    <span id="error-action-cross-sell" class="error-message hidden">Cross selling action is required.</span>
                </div>

                <div class="form-group" id="group-review">
                    <h2 class="text-2xl font-bold text-primary mb-4">Final Plan Summary</h2>
                    <div id="commitmentSummaryOutput" class="bg-gray-100 p-6 rounded-lg text-sm text-primary-text whitespace-pre-wrap border border-gray-300 font-mono">
                        Summary will appear here.
                    </div>
                </div>

            </div>

            <div id="navigation-buttons" class="mt-8 pt-4 border-t border-gray-300 flex justify-between items-center">
                <button type="button" id="prevButton" class="nav-button nav-button-default" style="display: none;">
                    ‚Üê Previous
                </button>
                
                <div class="flex-grow"></div>

                <div class="nav-button-group">
                     <button type="button" id="resetButton" class="nav-button nav-button-default">
                         Start Over
                     </button>
                     
                     <button type="button" id="printButton" class="nav-button nav-button-default text-center" style="display: none;">
                         Save as PDF
                     </button>
                     
                     <button type="button" id="copyCommitmentButton" class="nav-button nav-button-default text-center" style="display: none;">
                         Copy Commitment
                     </button>

                     <button type="button" id="exportJSONButton" class="nav-button nav-button-primary text-center" style="display: none;">
                         Export JSON Data
                     </button>
                     
                     <button type="button" id="nextButton" class="nav-button nav-button-primary">
                         Next ‚Üí
                     </button>
                </div>
            </div>

        </form>
    </div>
</div>

<script>
    // Global variable to store calculated data
    if (!window.planData) window.planData = {};

    // --- Helper Functions ---
    const $ = (selector) => document.getElementById(selector);
    
    const getNumberValue = (id) => {
        const el = $(id);
        if (!el) return 0;
        return parseFloat(el.value.replace(/[$,]/g, '')) || 0;
    };

    const getStringValue = (id) => {
        const el = $(id);
        if (!el) return '';
        return el.value.trim();
    };
    
    const getSelectedValue = (name) => {
        const checked = document.querySelector(`input[name="${name}"]:checked`);
        return checked ? checked.value : '';
    };

    const getSelectedLabel = (name) => {
        const checked = document.querySelector(`input[name="${name}"]:checked`);
        return checked ? checked.labels[0].textContent.trim().replace(/\s+/g, ' ') : '[Not Selected]';
    };

    const formatCurrency = (val) => {
        if (isNaN(val) || !isFinite(val)) return '$0';
        return '$' + val.toLocaleString('en-US', { maximumFractionDigits: 0 });
    };

    const formatPercent = (val) => {
        if (isNaN(val) || !isFinite(val)) return '0%';
        return val.toFixed(1) + '%';
    };
    const formatNumber = (val) => {
        if (isNaN(val) || !isFinite(val)) return '0';
        return val.toLocaleString('en-US', { maximumFractionDigits: 1 });
    };
    
    // --- Step Definitions (The Core Conversation) ---
    // All bolding now uses HTML <strong> tags
    const steps = [
        { id: 'intro', fieldId: null, prompt: "Welcome to the <strong>Trimble 2026 Success Plan Wizard</strong>! We're here to turn your ambition into measurable results. Hit <strong>Next</strong> to start establishing your baseline." }, // 0
        { id: 'personName', fieldId: 'personName', prompt: "Let's start with the hero of this story! <strong>What is your full name?</strong> This ensures your plan gets properly credited to you." }, // 1
        { id: 'managerName', fieldId: 'managerName', prompt: "Who's your co-pilot? <strong>Please enter your manager's full name.</strong> We need to know who to share your legendary commitment with!" }, // 2
        { id: 'region', fieldId: 'region', prompt: "Geography check! <strong>Which region are you primarily responsible for?</strong> This helps us analyze regional trends." }, // 3
        { id: 'quota2025', fieldId: 'quota2025', prompt: "Time for the look-back. <strong>What was your total assigned Quota for 2025?</strong> Enter the dollar amount only (no commas needed)." }, // 4
        { id: 'bookings2025', fieldId: 'bookings2025', prompt: "And the result? <strong>What were your total Bookings (Closed-Won Revenue) in 2025?</strong> Enter the dollar amount. (Watch the Attainment calculator update!)" }, // 5
        { id: 'winRate2025', fieldId: 'winRate2025', prompt: "Efficiency matters! <strong>What was your average Win Rate (%) in 2025?</strong> This is your baseline effectiveness. Enter the percentage (e.g., 25)." }, // 6
        { id: 'avgDealSize2025', fieldId: 'avgDealSize2025', prompt: "Value check! <strong>What was your average Deal Size ($) in 2025?</strong> This metric defines the volume of business you typically handle." }, // 7
        { id: 'avgMeetings2025', fieldId: 'avgMeetings2025', prompt: "Activity check! <strong>On average, how many <em>in-person</em> customer meetings did you conduct each quarter?</strong> This metric links activity to success." }, // 8
        { id: 'quota2026', fieldId: 'quota2026', prompt: "Forward look! <strong>What is your new 2026 Quota Commitment?</strong> Enter the amount. The system will now calculate the massive pipeline and deal volume required <em>if</em> your 2025 efficiency remains the same." }, // 9
        { id: 'reflection', fieldId: 'reflection', prompt: "Based on the intimidating required pipeline and deal count above, <strong>how do you feel about your 2026 goal?</strong> Be honest‚Äîthis sets the stage for where you need to focus!" }, // 10
        { id: 'winRateImprovement', fieldId: 'winRateImprovement', prompt: "<h3>üí° SCENARIO MODELING: LEVER 1 (Quality)</h3> Improving your <strong>Win Rate</strong> reduces the sheer amount of pipeline you need. <strong>How much better can you get?</strong> Adjust the slider to commit to a Win Rate percentage gain." }, // 11
        { id: 'dealSizeImprovement', fieldId: 'dealSizeImprovement', prompt: "<h3>üí° SCENARIO MODELING: LEVER 2 (Value)</h3> Increasing your <strong>Avg. Deal Size</strong> reduces the <em>number of deals</em> you have to close. <strong>How much larger can you make your deals?</strong> Adjust the slider to commit to a percentage gain." }, // 12
        { id: 'meetingImprovement', fieldId: 'meetingImprovement', prompt: "<h3>üí° SCENARIO MODELING: LEVER 3 (Activity)</h3> Commit to increasing your <strong>Quarterly In-Person Meetings</strong>. Then, set the <strong>Implied New Win Rate (%)</strong> you believe this increased activity will deliver. This sets your activity target!" }, // 13
        { id: 'primaryGoal', fieldId: 'primaryGoal', prompt: "<h3>üöÄ ACTION PLAN: PRIMARY FOCUS</h3> Based on the modeling you just completed, <strong>which lever(s) will be your primary focus in 2026?</strong> Choose the one that gives you the best return on effort." }, // 14
        { id: 'action-people', fieldId: 'action-people', prompt: "<h3>üöÄ ACTION PLAN: PEOPLE</h3> Commit to a <strong>measurable action</strong> focused on <strong>PEOPLE</strong> (e.g., training, coaching, skill development). What is your growth action for 2026?" }, // 15
        { id: 'action-pipeline', fieldId: 'action-pipeline', prompt: "<h3>üöÄ ACTION PLAN: PIPELINE</h3> Commit to a <strong>measurable action</strong> focused on <strong>PIPELINE</strong> (e.g., qualification, deal flow, prospecting). What action improves your deal quality?" }, // 16
        { id: 'action-productivity', fieldId: 'action-productivity', prompt: "<h3>üöÄ ACTION PLAN: PRODUCTIVITY</h3> Commit to a <strong>measurable action</strong> focused on <strong>PRODUCTIVITY</strong> (e.g., tech stack use, time management). What action saves you time or increases efficiency?" }, // 17
        { id: 'action-forecast', fieldId: 'action-forecast', prompt: "<h3>üöÄ ACTION PLAN: FORECASTING</h3> <strong>My Rep Commit will be 95-105% accurate every quarter.</strong> What is the <strong>Key Action</strong> you will take to guarantee this predictability?" }, // 18
        { id: 'action-account-plan', fieldId: 'action-account-plan', prompt: "<h3>üöÄ ACTION PLAN: GROWTH</h3> Define your plan for <strong>Account Planning</strong>. What measurable step will you take to manage strategic accounts better?" }, // 19
        { id: 'action-cross-sell', fieldId: 'action-cross-sell', prompt: "<h3>üöÄ ACTION PLAN: GROWTH</h3> Define your plan for <strong>Cross Selling</strong>. What measurable step will you take to expand business within existing accounts?" }, // 20
        { id: 'review', fieldId: 'review', prompt: "<h3>‚úÖ COMMITMENT REVIEW</h3> Congratulations! You have defined your 2026 Success Plan. Review the final commitment summary below, and when you are ready, click <strong>Export JSON Data</strong> to submit your plan to your manager.", group: $('group-review') } // 21
    ];
    
    // Groups that need validation (excluding intro and review)
    const fieldGroups = steps.filter(s => s.fieldId && s.fieldId !== 'review').map(s => $(`group-${s.fieldId}`)).filter(Boolean);

    let currentStepIndex = 0;
    
    // --- Validation Logic (Retained) ---
    function validateField(fieldId) {
        const input = $(fieldId);
        const errorElement = $(`error-${fieldId}`);
        const value = getStringValue(fieldId);
        
        let isValid = true;
        let isNumeric = input && input.classList.contains('numeric-field');
        let numValue = isNumeric ? getNumberValue(fieldId) : 0;

        // Clear previous errors
        if (input) input.classList.remove('error');
        if (errorElement) errorElement.classList.add('hidden');

        // Check for required text/select inputs
        if (input && input.classList.contains('required-field') && !value) {
            isValid = false;
        } 
        
        // Check for required numeric inputs (must be > 0 and a number)
        else if (isNumeric && (numValue <= 0 || !isFinite(numValue))) {
            if (fieldId !== 'bookings2025' && fieldId !== 'meetingsImpliedWinRate_visible') {
                isValid = false;
            }
        }
        
        // Specific checks for Win Rate bounds (0-100)
        else if (fieldId === 'winRate2025' && (numValue < 0 || numValue > 100)) {
            isValid = false;
        }

        // Check for required radio buttons
        if (input && input.classList.contains('required-radio')) {
            const radioName = input.name;
            if (!getSelectedValue(radioName)) {
                const radioError = $(`error-${radioName}`);
                if (radioError) radioError.classList.remove('hidden');
                isValid = false;
            }
        }

        if (!isValid) {
            if (input) input.classList.add('error');
            if (errorElement) errorElement.classList.remove('hidden');
        }

        return isValid;
    }
    
    function validateCurrentStep() {
        const step = steps[currentStepIndex];
        const fieldId = step.fieldId;
        
        if (!fieldId) return true;

        if (fieldId.includes('action-') || fieldId === 'primaryGoal') {
             const requiredGroupFields = document.querySelectorAll(`#group-${fieldId} .required-field, #group-${fieldId} .required-radio`);
             let groupValid = true;
             requiredGroupFields.forEach(field => {
                 if (!validateField(field.id)) {
                     groupValid = false;
                 }
             });
             return groupValid;
        } else if (fieldId === 'reflection') {
             return !!getSelectedValue('reflection');
        } else if (fieldId === 'meetingsImpliedWinRate_visible') {
             return validateField(fieldId);
        } else {
            return validateField(fieldId);
        }
    }


    // --- Core Calculation Function (Retained) ---
    function calculatePlan() {
        const quota2025 = getNumberValue('quota2025');
        const bookings2025 = getNumberValue('bookings2025');
        const winRate2025 = getNumberValue('winRate2025');
        const avgDealSize2025 = getNumberValue('avgDealSize2025');
        const avgMeetings2025 = getNumberValue('avgMeetings2025');
        
        const quota2026 = getNumberValue('quota2026');
        const winRateImprovement = getNumberValue('winRateImprovement');
        const dealSizeImprovement = getNumberValue('dealSizeImprovement');
        const meetingImprovement = getNumberValue('meetingImprovement');
        
        const meetingsImpliedWinRateVisible = getNumberValue('meetingsImpliedWinRate_visible');
        const meetingsImpliedWinRateHidden = $('meetingsImpliedWinRate');
        if(meetingsImpliedWinRateHidden) meetingsImpliedWinRateHidden.value = meetingsImpliedWinRateVisible;
        const meetingsImpliedWinRate = meetingsImpliedWinRateVisible;

        const attainment2025 = quota2025 > 0 ? (bookings2025 / quota2025) * 100 : 0;
        if($('attainment2025')) $('attainment2025').textContent = formatPercent(attainment2025);

        const winRateDecimal = winRate2025 / 100;
        const pipelineToClose2026 = winRateDecimal > 0 ? quota2026 / winRateDecimal : 0;
        const dealsToClose2026 = avgDealSize2025 > 0 ? pipelineToClose2026 / avgDealSize2025 : 0;
        
        if($('pipelineToClose2026')) $('pipelineToClose2026').textContent = formatCurrency(pipelineToClose2026);
        if($('dealsToClose2026')) $('dealsToClose2026').textContent = formatNumber(dealsToClose2026);
        
        window.planData.pipelineToClose2026 = pipelineToClose2026;
        window.planData.dealsToClose2026 = dealsToClose2026;

        const newWinRate = winRate2025 + winRateImprovement;
        const newWinRateDecimal = newWinRate / 100;
        const newPipelineNeeded = newWinRateDecimal > 0 ? quota2026 / newWinRateDecimal : 0;
        
        if($('winRateImprovementLabel')) $('winRateImprovementLabel').textContent = `${winRateImprovement.toFixed(1)}%`;
        if($('newWinRateLabel')) $('newWinRateLabel').textContent = formatPercent(newWinRate);
        if($('newPipelineNeeded')) $('newPipelineNeeded').textContent = formatCurrency(newPipelineNeeded);

        const newAvgDealSize = avgDealSize2025 * (1 + (dealSizeImprovement / 100));
        const newDealsNeeded = newAvgDealSize > 0 ? quota2026 / newAvgDealSize : dealsToClose2026;
        
        if($('dealSizeImprovementLabel')) $('dealSizeImprovementLabel').textContent = `${dealSizeImprovement.toFixed(0)}%`;
        if($('newAvgDealSizeLabel')) $('newAvgDealSizeLabel').textContent = formatCurrency(newAvgDealSize);
        if($('newDealsNeeded')) $('newDealsNeeded').textContent = formatNumber(newDealsNeeded);
        
        const newMeetingAvg = avgMeetings2025 + meetingImprovement;
        const meetingsImpliedWinRateDecimal = meetingsImpliedWinRate / 100;
        const meetingsPipelineNeeded = meetingsImpliedWinRateDecimal > 0 ? quota2026 / meetingsImpliedWinRateDecimal : pipelineToClose2026;
        
        if($('meetingImprovementLabel')) $('meetingImprovementLabel').textContent = `${meetingImprovement.toFixed(0)}`;
        if($('newMeetingAvgLabel')) $('newMeetingAvgLabel').textContent = `${newMeetingAvg.toFixed(0)}`;
        if($('meetingsPipelineNeeded')) $('meetingsPipelineNeeded').textContent = formatCurrency(meetingsPipelineNeeded);
        
        const finalTargetWinRate = Math.max(newWinRate, meetingsImpliedWinRate);
        window.planData.finalTargetWinRate = finalTargetWinRate;
        window.planData.finalTargetPipeline = finalTargetWinRate > 0 ? quota2026 / (finalTargetWinRate / 100) : pipelineToClose2026;

        if (steps[currentStepIndex].id === 'review') generateCommitmentSummary();
    }

    // --- Step 21 Summary Generation (Retained) ---
    function generateCommitmentSummary() {
        // Collect all data
        const personName = getStringValue('personName');
        const managerName = getStringValue('managerName');
        const region = $('region').value || '[Not Provided]';
        const reflection = getSelectedLabel('reflection');
        const goalSelection = getSelectedLabel('primaryGoal');
        
        // Calculation outputs
        const winRate2025 = getNumberValue('winRate2025');
        const avgDealSize2025 = getNumberValue('avgDealSize2025');
        const attainment2025 = $('attainment2025').textContent;
        const quota2026 = formatCurrency(getNumberValue('quota2026'));

        // Scenario outputs (using the harmonized target for clarity)
        const targetWinRate = formatPercent(window.planData.finalTargetWinRate || winRate2025);
        const targetDealSize = $('newAvgDealSizeLabel').textContent;
        const baselinePipeline = formatCurrency(window.planData.pipelineToClose2026 || 0);
        const targetPipeline = formatCurrency(window.planData.finalTargetPipeline || 0);
        const dealsToClose2026 = formatNumber(window.planData.dealsToClose2026 || 0);
        
        // Action Items
        const actions = {
            people: getStringValue('action-people'),
            pipeline: getStringValue('action-pipeline'),
            productivity: getStringValue('action-productivity'),
            forecast: getStringValue('action-forecast'),
            accountPlan: getStringValue('action-account-plan'),
            crossSell: getStringValue('action-cross-sell'),
        };

        const summaryText = `
**TRIMBLE 2026 SALES COMMITMENT PLAN (FINAL)**

**1. Personal & Financial Baseline (Look Back)**
- Rep: ${personName}
- Manager: ${managerName}
- Region: ${region}
- 2026 Quota Commitment: ${quota2026}
- 2025 Attainment: ${attainment2025}
- 2025 Baseline Win Rate: ${winRate2025}%
- 2025 Baseline Avg. Deal Size: ${formatCurrency(avgDealSize2025)}
- Required Deals (at baseline efficiency): ${dealsToClose2026}

**2. Strategy & Targets (Scenarios)**
- Overall Reflection: ${reflection}
- Primary Focus Lever: ${goalSelection}
- **COMMITTED TARGETED WIN RATE:** ${targetWinRate} 
- Targeted Avg. Deal Size: ${targetDealSize}
- Baseline Pipeline Required: ${baselinePipeline}
- **Target Pipeline Required (After Gains):** ${targetPipeline} (Goal)

**3. Key Action Plan (PEOPLE, PIPELINE & PRODUCTIVITY)**
- **PEOPLE Commitment:** ${actions.people}
- **PIPELINE Commitment:** ${actions.pipeline}
- **PRODUCTIVITY Commitment:** ${actions.productivity}

**4. Predictability & Growth**
- **Forecasting Action:** ${actions.forecast}
- **Account Planning:** ${actions.accountPlan}
- **Cross Selling:** ${actions.crossSell}

---
*Generated by the Trimble 2026 Success Planner.*
        `.trim();
        
        $('commitmentSummaryOutput').textContent = summaryText;
        return summaryText;
    }

    // --- JSON Export (Retained) ---
    function generateJSONData() {
        calculatePlan(); 
        
        const metadata = {
            plan_version: "2026.5",
            date_exported: new Date().toISOString(),
            rep_name: getStringValue('personName'),
            manager_name: getStringValue('managerName'),
            region: $('region').value || 'Unknown',
            quota_2025: getNumberValue('quota2025'),
            bookings_2025: getNumberValue('bookings2025'),
        };

        const inputs = {
            quota_2026: getNumberValue('quota2026'),
            win_rate_2025: getNumberValue('winRate2025'),
            avg_deal_size_2025: getNumberValue('avgDealSize2025'),
            meetings_2025_avg: getNumberValue('avgMeetings2025'),
            
            lever_selected: getSelectedValue('primaryGoal'),
            reflection: getSelectedValue('reflection'),
            
            // Scenario Inputs
            win_rate_improvement_pct: getNumberValue('winRateImprovement'),
            deal_size_improvement_pct: getNumberValue('dealSizeImprovement'),
            meetings_increase_abs: getNumberValue('meetingImprovement'),
            implied_win_rate_l3: getNumberValue('meetingsImpliedWinRate'),

            // Harmonized Outputs
            win_rate_target_pct: window.planData.finalTargetWinRate || getNumberValue('winRate2025'), 
            deal_size_target_value: getNumberValue('avgDealSize2025') * (1 + (getNumberValue('dealSizeImprovement') / 100)),
            pipeline_required_target: window.planData.finalTargetPipeline || 0
        };

        const actions = {
            people: getStringValue('action-people'),
            pipeline: getStringValue('action-pipeline'),
            productivity: getStringValue('action-productivity'),
            forecast: getStringValue('action-forecast'),
            account_plan: getStringValue('action-account-plan'),
            cross_sell: getStringValue('action-cross-sell'),
        };

        return { metadata, inputs, actions };
    }

    // --- Wizard Logic (Retained) ---
    function showStep(stepIndex) {
        document.querySelectorAll('.form-group').forEach(group => {
            group.style.display = 'none';
        });
        document.querySelectorAll('.error-message').forEach(error => {
            error.classList.add('hidden');
        });
        
        currentStepIndex = stepIndex;
        const step = steps[stepIndex];
        
        $('conversation-bubble').innerHTML = step.prompt;

        const groupElements = document.querySelectorAll(`#group-${step.fieldId}`);
        groupElements.forEach(el => {
            el.style.display = 'block';
        });
        
        if (stepIndex >= 11 && stepIndex <= 13) {
            $('group-winRateImprovement').style.display = 'block';
            $('group-dealSizeImprovement').style.display = 'block';
            $('group-meetingImprovement').style.display = 'block';
        }

        const isReviewStep = step.id === 'review';
        if (isReviewStep) generateCommitmentSummary();

        $('prevButton').style.display = stepIndex > 0 ? 'inline-block' : 'none';
        $('nextButton').style.display = isReviewStep ? 'none' : 'inline-block';
        
        const finalActionsVisible = isReviewStep;
        $('exportJSONButton').style.display = finalActionsVisible ? 'inline-block' : 'none';
        $('copyCommitmentButton').style.display = finalActionsVisible ? 'inline-block' : 'none';
        $('printButton').style.display = finalActionsVisible ? 'inline-block' : 'none';

        const currentInput = step.fieldId ? $(step.fieldId) || document.querySelector(`#group-${step.fieldId} input, #group-${step.fieldId} select, #group-${step.fieldId} textarea`) : null;
        if (currentInput) currentInput.focus();

        updateNextButtonState();
    }

    function updateNextButtonState() {
        const nextButton = $('nextButton');
        if (!nextButton || steps[currentStepIndex].id === 'review') return;
        
        if (currentStepIndex >= 11 && currentStepIndex <= 13) {
            nextButton.disabled = false;
            return;
        }

        const isValid = validateCurrentStep();
        nextButton.disabled = !isValid;
    }

    function nextStep() {
        if (currentStepIndex >= 11 && currentStepIndex <= 13) {
             currentStepIndex = 14; 
             showStep(currentStepIndex);
             return;
        }
        
        if (validateCurrentStep()) {
            if (currentStepIndex < steps.length - 1) {
                currentStepIndex++;
                showStep(currentStepIndex);
            }
        }
    }

    function previousStep() {
        if (currentStepIndex > 0) {
            if (currentStepIndex > 14) {
                 currentStepIndex = 14;
            } else if (currentStepIndex >= 11 && currentStepIndex <= 13) {
                currentStepIndex = 10;
            } else {
                currentStepIndex--;
            }
            showStep(currentStepIndex);
        }
    }

    // --- Data Download & Copy Handlers (Retained) ---
    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => {
            const button = $('copyCommitmentButton');
            const originalText = button.textContent;
            
            button.textContent = 'COPIED!';
            setTimeout(() => {
                button.textContent = originalText;
            }, 1500);
        }).catch(err => {
            alert("Failed to copy text. Please manually copy the text from the box above.");
        });
    }

    function downloadJSON(data, filename) {
        const json = JSON.stringify(data, null, 2);
        const blob = new Blob([json], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }
    
    // --- Initialization (Retained) ---
    document.addEventListener('DOMContentLoaded', () => {
        
        const inputsToTrack = [
            'quota2025', 'bookings2025', 'avgDealSize2025', 'region', 'personName', 'managerName', 'avgMeetings2025',
            'quota2026', 'winRate2025', 'winRateImprovement', 
            'dealSizeImprovement', 'meetingImprovement', 'meetingsImpliedWinRate_visible',
            'action-people', 'action-pipeline', 'action-productivity', 'action-forecast', 'action-account-plan', 'action-cross-sell'
        ];
        
        inputsToTrack.forEach(id => {
            const el = $(id);
            if (el) {
                const handler = () => {
                    calculatePlan();
                    if (currentStepIndex === steps.findIndex(s => s.fieldId === id) || (currentStepIndex >= 14)) {
                         updateNextButtonState();
                    }
                };
                el.addEventListener('input', handler);
                el.addEventListener('change', handler);
            }
        });
        
        const radioNames = ['reflection', 'primaryGoal'];
        radioNames.forEach(name => {
            document.querySelectorAll(`input[name="${name}"]`).forEach(radio => {
                radio.addEventListener('change', () => {
                    calculatePlan();
                    updateNextButtonState();
                });
            });
        });

        $('nextButton').addEventListener('click', nextStep);
        $('prevButton').addEventListener('click', previousStep);
        
        $('resetButton').addEventListener('click', () => {
            if(confirm("Are you sure you want to start over? All entered data will be lost.")) {
                if($('skoForm')) $('skoForm').reset();
                calculatePlan();
                showStep(0);
                if($('main-heading')) $('main-heading').focus();
            }
        });

        $('printButton').addEventListener('click', () => {
            window.print();
        });
        
        $('copyCommitmentButton').addEventListener('click', () => {
            const summary = generateCommitmentSummary();
            copyToClipboard(summary);
        });
        
        $('exportJSONButton').addEventListener('click', () => {
            const data = generateJSONData();
            const repName = getStringValue('personName') || 'SalesRep';
            const fileName = `Trimble_2026_Plan_${repName.replace(/\s/g, '_')}.json`;
            downloadJSON(data, fileName);
        });

        calculatePlan();
        showStep(0);
    });
</script>
