<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trimble 2026 Success Plan</title>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#0063a3',      // Trimble primary blue
                        'accent': '#fbad26',       // Trimble accent orange/amber
                        'success': '#02542e',      // Trimble Green
                        'primary-text': '#252a2e', // Trimble primary dark text
                        'system-bg': '#f3f6f9',    // Light background for conversation box
                    },
                    fontFamily: {
                        'sans': ['Open Sans', 'sans-serif'] // Set default font
                    }
                }
            }
        }
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* Base Styles */
        body {
            font-family: 'Open Sans', sans-serif;
            color: #252a2e;
        }
        
        /* Wizard Container */
        .wizard-container {
            max-width: 100%;
            margin-left: 0.5rem;
            margin-right: 0.5rem;
            padding: 1rem;
            background-color: #ffffff;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1); 
            margin-top: 1rem;
            margin-bottom: 1rem;
        }
        @media (min-width: 768px) {
            .wizard-container {
                max-width: 48rem;
                margin-left: auto;
                margin-right: auto;
                padding: 2.5rem;
                box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
                margin-top: 3rem;
                margin-bottom: 3rem;
            }
        }
        
        /* NEW: Progress Bar (6 Segments) */
        .progress-bar {
            display: flex;
            width: 100%;
            background-color: #e5e7eb; /* gray-200 */
            border-radius: 0.5rem;
            overflow: hidden;
            margin-bottom: 2rem; /* MOVED TO TOP */
        }
        .progress-segment {
            flex: 1;
            padding: 0.5rem 0.25rem; /* Tighter padding for 6 segments */
            text-align: center;
            font-size: 0.65rem; /* Smaller text for 6 segments */
            font-weight: 700;
            color: #4b5563; /* gray-600 */
            border-right: 2px solid #ffffff;
            transition: all 0.3s ease;
        }
        .progress-segment:last-child {
            border-right: none;
        }
        @media (min-width: 768px) {
            .progress-segment {
                font-size: 0.8rem;
                padding: 0.75rem 0.5rem;
            }
        }
        .progress-segment.active {
            color: #ffffff;
        }
        .progress-segment.complete {
            color: #ffffff;
            opacity: 0.7;
        }
        /* Phase-specific colors */
        #progress-1.active, #progress-1.complete { background-color: #0063a3; /* primary */ }
        #progress-2.active, #progress-2.complete { background-color: #fbad26; /* accent */ }
        #progress-3.active, #progress-3.complete { background-color: #0063a3; /* primary */ }
        #progress-4.active, #progress-4.complete { background-color: #fbad26; /* accent */ }
        #progress-5.active, #progress-5.complete { background-color: #02542e; /* success */ }
        #progress-6.active, #progress-6.complete { background-color: #252a2e; /* primary-text */ }


        /* Conversation Bubble */
        .conversation-bubble {
            background-color: #f3f6f9;
            border: 1px solid #e5e7eb;
            padding: 1rem;
            margin-bottom: 1.5rem;
            border-radius: 0.5rem;
            font-size: 1rem;
            line-height: 1.5;
            border-left-width: 4px;
            border-left-color: #e5e7eb;
        }
        /* Phase-specific bubble colors */
        .phase-1-bubble { border-left-color: #0063a3; }
        .phase-2-bubble { border-left-color: #fbad26; }
        .phase-3-bubble { border-left-color: #0063a3; }
        .phase-4-bubble { border-left-color: #fbad26; }
        .phase-5-bubble { border-left-color: #02542e; }
        .phase-6-bubble { border-left-color: #252a2e; }

        @media (min-width: 768px) {
            .conversation-bubble {
                padding: 1.5rem;
                font-size: 1.05rem;
                line-height: 1.6;
                margin-bottom: 2rem;
            }
        }
        .conversation-bubble strong {
            color: #0063a3;
            font-weight: 700;
        }
        .prompt-why {
            margin-top: 0.75rem;
            font-size: 1rem;
            line-height: 1.5;
        }
        .prompt-example {
            font-size: 0.9rem;
            font-style: italic;
            color: #4B5563;
            margin-top: 0.75rem;
            padding: 0.5rem 1rem;
            border-left: 3px solid #fbad26;
            background-color: #fcfcfc;
        }

        /* Input Styling */
        .input-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
            color: #252a2e;
            margin-bottom: 0.25rem;
        }
        .input-field {
            display: block;
            width: 100%;
            border-radius: 0.375rem;
            border: 1px solid #D1D5DB;
            padding: 0.5rem 0.75rem;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            color: #252a2e;
            font-family: 'Open Sans', sans-serif;
            font-size: 1rem;
        }
        .input-field:focus {
            outline: 2px solid transparent;
            outline-offset: 2px;
            border-color: #0063a3;
            box-shadow: 0 0 0 2px rgba(0, 99, 163, 0.3);
        }
        .input-field.error {
            border-color: #B91C1C;
            box-shadow: 0 0 0 2px rgba(185, 28, 28, 0.3);
        }
        .error-message {
            color: #B91C1C;
            font-size: 0.75rem;
            margin-top: 0.25rem;
        }
        
        /* Calculation & Results Boxes */
        .calc-box {
            background-color: #F9FAFB;
            border: 1px solid #E5E7EB;
            border-radius: 0.5rem;
            padding: 0.75rem;
        }
        .calc-output {
            display: block;
            font-size: 1.75rem;
            font-weight: 700;
            color: #0063a3;
            margin-top: 0.25rem;
        }
        @media (min-width: 768px) {
            .calc-output {
                font-size: 1.875rem;
            }
        }
        .calc-box-accent {
            background-color: #fbad26; /* accent */
            color: #252a2e;
            border-radius: 0.5rem;
            padding: 1rem;
        }
        .calc-output-accent {
            display: block;
            font-size: 1.75rem;
            font-weight: 700;
            color: #252a2e;
            margin-top: 0.25rem;
        }
        
        /* Slider Styles */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: #d3d3d3;
            outline: none;
            opacity: 0.9;
            transition: opacity .2s;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #0063a3;
            cursor: pointer;
            box-shadow: 0 0 5px rgba(0,0,0,0.2);
        }
        
        /* Hide number input arrows */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
        
        /* Navigation Buttons */
        .nav-button-group {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            justify-content: flex-end;
        }
        .nav-button {
            display: inline-block;
            padding: 0.625rem 1.25rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 600;
            text-align: center;
            border: 1px solid transparent;
            transition: all 0.2s;
            cursor: pointer;
            white-space: nowrap;
        }
        .nav-button-primary {
            background-color: #0063a3;
            color: #FFFFFF;
        }
        .nav-button-primary:hover {
            background-color: #004a7c;
        }
        .nav-button-primary:disabled {
            background-color: #D1D5DB;
            cursor: not-allowed;
        }
        .nav-button-default {
            background-color: #E5E7EB;
            color: #252a2e;
        }
        .nav-button-default:hover {
            background-color: #D1D5DB;
        }
        
        /* Print styles */
        @media print {
            body { background-color: white !important; color: #252a2e !important; }
            .wizard-container { box-shadow: none !important; margin: 0 !important; padding: 0 !important; width: 100% !important; max-width: 100% !important; }
            #navigation-buttons, .progress-bar, .conversation-bubble, .error-message, .tooltip-trigger { display: none !important; }
            .step-heading { margin-top: 2rem; page-break-before: auto; page-break-inside: avoid; }
            .form-group, .hidden-step-content { display: block !important; visibility: visible !important; }
            input, select, textarea { border: 1px solid #ccc !important; }
            #form-fields > div { display: block !important; }
            .calc-output { color: #000 !important; }
        }
    </style>
</head>

<body class="bg-gray-100">
    <div class="wizard-container">
        <header class="mb-6 text-center space-y-2">
            <h1 id="main-heading" class="text-2xl md:text-3xl font-bold text-primary">The Trimble 2026 Success Plan</h1>
            <p class="text-base md:text-lg font-semibold text-primary-text">Personal Commitment Wizard</p>
        </header>

        <div class="progress-bar" id="progress-bar-container">
            <div id="progress-1" class="progress-segment">BASELINE</div>
            <div id="progress-2" class="progress-segment">THE GAP</div>
            <div id="progress-3" class="progress-segment">PIPE PLAN</div>
            <div id="progress-4" class="progress-segment">SCENARIOS</div>
            <div id="progress-5" class="progress-segment">ACTION PLAN</div>
            <div id="progress-6" class="progress-segment">REVIEW</div>
        </div>

        <form id="skoForm" onsubmit="return false;">

            <div id="conversation-bubble" class="conversation-bubble">
                </div>
            
            <div id="hidden-step-content" style="display: none;">
                <input type="number" id="meetingsImpliedWinRate" value="0">
            </div>

            <div id="form-fields" class="space-y-6">

                <div class="form-group" id="group-intro"></div>
                
                <div class="form-group" id="group-phase1-welcome"></div>

                <div class="form-group" id="group-personName">
                    <label for="personName" class="input-label">My Full Name:</label>
                    <input type="text" id="personName" class="input-field required-field" placeholder="e.g., Jane Doe">
                    <span id="error-personName" class="error-message hidden">Your name is required.</span>
                </div>

                <div class="form-group" id="group-managerName">
                    <label for="managerName" class="input-label">My Manager's Name:</label>
                    <input type="text" id="managerName" class="input-field required-field" placeholder="e.g., John Smith">
                    <span id="error-managerName" class="error-message hidden">Your manager's name is required.</span>
                </div>

                <div class="form-group" id="group-region">
                    <label for="region" class="input-label">My Region:</label>
                    <select id="region" class="input-field required-field">
                        <option value="" disabled selected>Select your region</option>
                        <option value="NA">NA (North America)</option>
                        <option value="EMEA">EMEA</option>
                        <option value="APAC">APAC</option>
                    </select>
                    <span id="error-region" class="error-message hidden">Region selection is required.</span>
                </div>

                <div class="form-group" id="group-quota2025">
                    <label for="quota2025" class="input-label">My 2025 Quota ($):</label>
                    <input type="text" id="quota2025" class="input-field required-field numeric-field" placeholder="e.g., 1,000,000">
                    <span id="error-quota2025" class="error-message hidden">Valid quota amount is required.</span>
                </div>
                
                <div class="form-group" id="group-bookings2025">
                    <label for="bookings2025" class="input-label">My 2025 Bookings ($):</label>
                    <input type="text" id="bookings2025" class="input-field required-field numeric-field" placeholder="e.g., 1,100,000">
                    <span id="error-bookings2025" class="error-message hidden">Valid bookings amount is required.</span>
                    <div class="calc-box mt-4">
                        <span class="text-sm font-medium text-gray-700">Calculated 2025 Attainment:</span>
                        <span id="attainment2025" class="calc-output">0%</span>
                    </div>
                </div>
                
                <div class="form-group" id="group-winRate2025">
                    <label for="winRate2025" class="input-label">My 2025 Baseline Win Rate (%):</label>
                    <div class="relative">
                        <span class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-500">%</span>
                        <input type="number" id="winRate2025" class="input-field required-field pr-7" placeholder="e.g., 25">
                    </div>
                    <span id="error-winRate2025" class="error-message hidden">Valid win rate is required (0-100).</span>
                </div>

                <div class="form-group" id="group-avgDealSize2025">
                    <label for="avgDealSize2025" class="input-label">My 2025 Avg. Deal Size ($):</label>
                    <input type="text" id="avgDealSize2025" class="input-field required-field numeric-field" placeholder="e.g., 50,000">
                    <span id="error-avgDealSize2025" class="error-message hidden">Valid average deal size is required.</span>
                </div>
                
                <div class="form-group" id="group-avgMeetings2025">
                    <label for="avgMeetings2025" class="input-label">My 2025 Avg. In-Person Meetings (Quarterly):</label>
                    <input type="number" id="avgMeetings2025" class="input-field required-field" placeholder="e.g., 15">
                    <span id="error-avgMeetings2025" class="error-message hidden">Average meetings number is required.</span>
                </div>
                
                <div class="form-group" id="group-phase2-welcome"></div>

                <div class="form-group" id="group-quota2026">
                    <label for="quota2026" class="input-label">My 2026 Quota Commitment ($):</label>
                    <input type="text" id="quota2026" class="input-field required-field numeric-field" placeholder="e.g., 1,200,000">
                    <span id="error-quota2026" class="error-message hidden">2026 Quota is required.</span>
                    
                    <div class="calc-box mt-6">
                        <span class="text-sm font-medium text-gray-700">Required Pipeline (at 2025 efficiency):</span>
                        <span id="pipelineToClose2026" class="calc-output">0</span>
                        <span class="text-xs text-gray-500">Based on Quota / 2025 Win Rate</span>
                    </div>
                    <div class="calc-box mt-4">
                        <span class="text-sm font-medium text-gray-700">Required Deals (at 2025 efficiency):</span>
                        <span id="dealsToClose2026" class="calc-output">0</span>
                        <span class="text-xs text-gray-500">Based on Required Pipeline / 2025 Avg. Deal Size</span>
                    </div>
                </div>

                <div class="form-group" id="group-reflection">
                    <label class="input-label">My Reflection (Based on the calculated numbers, does my 2026 goal feel achievable?):</label>
                    <div class="flex flex-wrap gap-x-6 gap-y-2 mt-2">
                        <div class="flex items-center">
                            <input id="reflect-1" name="reflection" type="radio" value="Achievable" class="focus:ring-primary h-4 w-4 text-primary border-gray-300 required-radio">
                            <label for="reflect-1" class="ml-2 block text-sm text-primary-text">Achievable</label>
                        </div>
                        <div class="flex items-center">
                            <input id="reflect-2" name="reflection" type="radio" value="Challenging" class="focus:ring-primary h-4 w-4 text-primary border-gray-300 required-radio">
                            <label for="reflect-2" class="ml-2 block text-sm text-primary-text">Challenging</label>
                        </div>
                        <div class="flex items-center">
                            <input id="reflect-3" name="reflection" type="radio" value="Impossible" class="focus:ring-primary h-4 w-4 text-primary border-gray-300 required-radio">
                            <label for="reflect-3" class="ml-2 block text-sm text-primary-text">Impossible</label>
                        </div>
                    </div>
                    <span id="error-reflection" class="error-message hidden">Please select an assessment of the goal.</span>
                </div>
                
                <div class="form-group" id="group-recommendedCoverage">
                    <label for="recommendedCoverage" class="input-label">My Recommended Pipeline Coverage (from Scorecard):</label>
                    <div class="relative">
                        <span class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-500">x</span>
                        <input type="number" id="recommendedCoverage" class="input-field required-field pr-7" placeholder="e.g., 1.9">
                    </div>
                    <span id="error-recommendedCoverage" class="error-message hidden">A coverage number (e.g., 1.9) is required.</span>
                    
                    <div class="calc-box-accent mt-4">
                        <span class="text-sm font-medium">Your Total Pipeline Gap:</span>
                        <span id="pipelineGap" class="calc-output-accent">$0</span>
                        <span class="text-xs">(2026 Quota * Rec. Coverage) - (Current Pipeline)</span>
                    </div>
                </div>

                <div class="form-group" id="group-pipelineMix">
                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <label for="mixNewLogo" class="input-label">New Logo %</label>
                            <input type="number" id="mixNewLogo" class="input-field required-field" placeholder="e.g., 20">
                        </div>
                        <div>
                            <label for="mixCrossSell" class="input-label">Cross-Sell %</label>
                            <input type="number" id="mixCrossSell" class="input-field required-field" placeholder="e.g., 50">
                        </div>
                        <div>
                            <label for="mixUpsell" class="input-label">Upsell %</label>
                            <input type="number" id="mixUpsell" class="input-field required-field" placeholder="e.g., 30">
                        </div>
                    </div>
                    <span id="error-pipelineMix" class="error-message hidden">All three values are required and must total 100%.</span>
                </div>
                
                <div class="form-group" id="group-pipelineSource">
                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <label for="sourceSelf" class="input-label">Self-Sourced %</label>
                            <input type="number" id="sourceSelf" class="input-field required-field" placeholder="e.g., 70">
                        </div>
                        <div>
                            <label for="sourceSDR" class="input-label">SDR-Sourced %</label>
                            <input type="number" id="sourceSDR" class="input-field required-field" placeholder="e.g., 20">
                        </div>
                        <div>
                            <label for="sourceMarketing" class="input-label">Marketing-Sourced %</label>
                            <input type="number" id="sourceMarketing" class="input-field required-field" placeholder="e.g., 10">
                        </div>
                    </div>
                    <span id="error-pipelineSource" class="error-message hidden">All three values are required and must total 100%.</span>
                </div>

                <div class="form-group" id="group-phase3-welcome"></div>

                <div class="form-group" id="group-winRateImprovement">
                    <div class="space-y-4 p-4 md:p-6 rounded-lg bg-primary/10 border border-primary/20">
                        <h3 class="text-xl font-semibold text-primary">Scenario 1: Improve Win Rate (Quality)</h3>
                        <label for="winRateImprovement" class="block text-sm font-medium text-primary-text">
                            Commit to improving Win Rate by: <span id="winRateImprovementLabel" class="font-bold text-primary">5.0%</span>
                            <br>(New Target Win Rate: <span id="newWinRateLabel" class="font-bold">0%</span>)
                        </label>
                        <input type="range" id="winRateImprovement" min="0" max="25" value="5" step="0.5" class="w-full">
                        
                        <div class="bg-white p-4 rounded-xl border border-primary/20 text-center">
                            <label class="text-sm font-medium text-primary-text">New Pipeline Needed</label>
                            <p id="newPipelineNeeded" class="text-2xl font-extrabold text-primary mt-1">0</p>
                        </div>
                    </div>
                </div>

                <div class="form-group" id="group-dealSizeImprovement">
                    <div class="space-y-4 p-4 md:p-6 rounded-lg bg-gray-100 border border-gray-300">
                        <h3 class="text-xl font-semibold text-primary-text">Scenario 2: Improve Avg. Deal Size (Value)</h3>
                        <label for="dealSizeImprovement" class="block text-sm font-medium text-primary-text">
                            Commit to improving Avg. Deal Size by: <span id="dealSizeImprovementLabel" class="font-bold text-primary-text">15%</span>
                            <br>(New Target Deal Size: <span id="newAvgDealSizeLabel" class="font-bold">0</span>)
                        </label>
                        <input type="range" id="dealSizeImprovement" min="0" max="50" value="15" step="1" class="w-full" style="--thumb-color: #252a2e;">
                        
                        <div class="bg-white p-4 rounded-xl border border-gray-300 text-center">
                            <label class="text-sm font-medium text-primary-text">New Deals Needed</label>
                            <p id="newDealsNeeded" class="text-2xl font-extrabold text-primary-text mt-1">0</p>
                        </div>
                    </div>
                </div>
                
                <div class="form-group" id="group-meetingImprovement">
                    <div class="space-y-4 p-4 md:p-6 rounded-lg bg-gray-100 border border-gray-300">
                        <h3 class="text-xl font-semibold text-primary-text">Scenario 3: Increase Meetings (Activity)</h3>
                        <p class="text-sm text-primary-text/80">Context: More face-time = more predictable deals.</p>
                        
                        <label for="meetingImprovement" class="block text-sm font-medium text-primary-text">
                            Commit to increasing Avg. Quarterly Meetings by: <span id="meetingImprovementLabel" class="font-bold text-primary-text">5</span>
                            <br>(New Quarterly Avg: <span id="newMeetingAvgLabel" class="font-bold">0</span>)
                        </label>
                        <input type="range" id="meetingImprovement" min="0" max="20" value="5" step="1" class="w-full" style="--thumb-color: #252a2e;">
                        
                        <label for="meetingsImpliedWinRate_visible" class="block text-sm font-medium text-primary-text mt-4">
                            My Implied New Win Rate (%):
                        </label>
                        <div class="relative">
                            <span class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-500">%</span>
                            <input type="number" id="meetingsImpliedWinRate_visible" class="input-field pr-7" placeholder="e.g., 28" data-sync-id="meetingsImpliedWinRate">
                        </div>
                        <span id="error-meetingsImpliedWinRate_visible" class="error-message hidden">A valid Win Rate is required for this lever.</span>

                        <div class="bg-white p-4 rounded-xl border border-gray-300 text-center">
                            <label class="text-sm font-medium text-primary-text">Implied Pipeline Needed</label>
                            <p id="meetingsPipelineNeeded" class="text-2xl font-extrabold text-primary-text mt-1">0</p>
                        </div>
                    </div>
                </div>

                <div class="form-group" id="group-primaryGoal">
                    <label class="input-label !font-semibold !text-base !text-primary-text">My Primary Goal (The Lever I will focus on):</label>
                    <div class="flex flex-wrap gap-x-6 gap-y-2 mt-2">
                        <div class="flex items-center">
                            <input id="goal-win-rate" name="primaryGoal" type="radio" value="Win Rate" class="focus:ring-primary h-4 w-4 text-primary border-gray-300 required-radio">
                            <label for="goal-win-rate" class="ml-2 block text-sm text-primary-text">Win Rate (Scenario 1)</label>
                        </div>
                        <div class="flex items-center">
                            <input id="goal-deal-size" name="primaryGoal" type="radio" value="Avg. Deal Size" class="focus:ring-primary h-4 w-4 text-primary border-gray-300 required-radio">
                            <label for="goal-deal-size" class="ml-2 block text-sm text-primary-text">Avg. Deal Size (Scenario 2)</label>
                        </div>
                        <div class="flex items-center">
                            <input id="goal-meetings" name="primaryGoal" type="radio" value="In-Person Meetings" class="focus:ring-primary h-4 w-4 text-primary border-gray-300 required-radio">
                            <label for="goal-meetings" class="ml-2 block text-sm text-primary-text">In-Person Meetings (Scenario 3)</label>
                        </div>
                        <div class="flex items-center">
                            <input id="goal-both" name="primaryGoal" type="radio" value="Both (L1 & L2)" class="focus:ring-primary h-4 w-4 text-primary border-gray-300 required-radio">
                            <label for="goal-both" class="ml-2 block text-sm text-primary-text">Both (S1 & S2)</label>
                        </div>
                        <div class="flex items-center">
                            <input id="goal-all-three" name="primaryGoal" type="radio" value="All Three Levers" class="focus:ring-primary h-4 w-4 text-primary border-gray-300 required-radio">
                            <label for="goal-all-three" class="ml-2 block text-sm text-primary-text">All Three Scenarios</label>
                        </div>
                    </div>
                    <span id="error-primaryGoal" class="error-message hidden">A primary goal is required.</span>
                </div>

                <div class="form-group" id="group-action-people">
                    <label class="input-label">Action: Focus on <strong>People</strong> (Training, Coaching, Skill-building):</label>
                    <input type="text" id="action-people" class="input-field required-field" placeholder="e.g., I will get certified on...">
                    <span id="error-action-people" class="error-message hidden">People action is required.</span>
                </div>
                
                <div class="form-group" id="group-action-productivity">
                    <label class="input-label">Action: Focus on <strong>Productivity</strong> (Tech Stack Use, Time Management):</label>
                    <input type="text" id="action-productivity" class="input-field required-field" placeholder="e.g., I will partner with my SDR...">
                    <span id="error-action-productivity" class="error-message hidden">Productivity action is required.</span>
                </div>

                <div class="form-group" id="group-action-forecast">
                    <label class="input-label">Key Action: Forecasting Commitment (How will you ensure 95-105% accuracy?)</label>
                    <input type="text" id="action-forecast" class="input-field required-field" placeholder="e.g., I will 'murder-board' my own commit list...">
                    <span id="error-action-forecast" class="error-message hidden">Forecasting action is required.</span>
                </div>

                <div class="form-group" id="group-action-account-plan">
                    <label class="input-label">Personal Improvement: Account Planning Action:</label>
                    <input type="text" id="action-account-plan" class="input-field required-field" placeholder="e.g., I will build a 4-quarter plan for my Top 10 accounts...">
                    <span id="error-action-account-plan" class="error-message hidden">Account planning action is required.</span>
                </div>

                <div class="form-group" id="group-review">
                    <h2 class="text-2xl font-bold text-primary mb-4">Final Plan Summary</h2>
                    <div id="commitmentSummaryOutput" class="bg-gray-100 p-4 md:p-6 rounded-lg text-sm text-primary-text whitespace-pre-wrap border border-gray-300 font-mono">
                        Summary will appear here.
                    </div>
                </div>

            </div>
            
            <div class="progress-bar" id="progress-bar-container">
                <div id="progress-1" class="progress-segment">BASELINE</div>
                <div id="progress-2" class="progress-segment">THE GAP</div>
                <div id="progress-3" class="progress-segment">PIPE PLAN</div>
                <div id="progress-4" class="progress-segment">SCENARIOS</div>
                <div id="progress-5" class="progress-segment">ACTION PLAN</div>
                <div id="progress-6" class="progress-segment">REVIEW</div>
            </div>

            <div id="navigation-buttons" class="mt-8 pt-4 border-t border-gray-300 flex justify-between items-center">
                <button type="button" id="prevButton" class="nav-button nav-button-default" style="display: none;">
                    ← Previous
                </button>
                
                <div class="flex-grow"></div>

                <div class="nav-button-group">
                     <button type="button" id="resetButton" class="nav-button nav-button-default">
                         Start Over
                     </button>
                     
                     <button type="button" id="printButton" class="nav-button nav-button-default text-center" style="display: none;">
                         Save as PDF
                     </button>
                     
                     <button type="button" id="copyCommitmentButton" class="nav-button nav-button-default text-center" style="display: none;">
                         Copy Commitment
                     </button>

                     <button type="button" id="exportJSONButton" class="nav-button nav-button-primary text-center" style="display: none;">
                         Export JSON Data
                     </button>
                     
                     <button type="button" id="nextButton" class="nav-button nav-button-primary">
                         Next →
                     </button>
                </div>
            </div>

        </form>
    </div>

    <script>
        // Global variable to store calculated data
        if (!window.planData) window.planData = {};
    
        // --- Helper Functions ---
        const $ = (selector) => document.getElementById(selector);
        
        const getNumberValue = (id) => {
            const el = $(id);
            if (!el) return 0;
            return parseFloat(el.value.replace(/[$,]/g, '')) || 0;
        };
    
        const getStringValue = (id) => {
            const el = $(id);
            if (!el) return '';
            return el.value.trim();
        };
        
        const getSelectedValue = (name) => {
            const checked = document.querySelector(`input[name="${name}"]:checked`);
            return checked ? checked.value : '';
        };
    
        const getSelectedLabel = (name) => {
            const checked = document.querySelector(`input[name="${name}"]:checked`);
            return checked ? checked.labels[0].textContent.trim().replace(/\s+/g, ' ') : '[Not Selected]';
        };
    
        const formatCurrency = (val) => {
            if (isNaN(val) || !isFinite(val)) return '$0';
            return '$' + val.toLocaleString('en-US', { maximumFractionDigits: 0 });
        };
    
        const formatPercent = (val) => {
            if (isNaN(val) || !isFinite(val)) return '0%';
            return val.toFixed(1) + '%';
        };
        const formatNumber = (val) => {
            if (isNaN(val) || !isFinite(val)) return '0';
            return val.toLocaleString('en-US', { maximumFractionDigits: 1 });
        };
        
        // --- Step Definitions (The Core Conversation) ---
        // NEW: Friendly tone, Phase "Front Pages" added
        const steps = [
            // --- Intro (Step 0) ---
            { id: 'intro', fieldId: null, phase: 1, prompt: "Alright, let's get started. This wizard is your personal coach for building a measurable 2026 Success Plan. We'll walk through three phases: looking at your 2025 data, finding your 2026 gap, and then building a smart action plan to close it. Ready? Hit <strong>Next</strong>." }, // 0
            
            // --- Phase 1: See the Data (Steps 1-9) ---
            { id: 'phase1-welcome', fieldId: null, phase: 1, prompt: "<h3>PHASE 1: SEE THE DATA (Your Baseline)</h3><p class='prompt-why'>First, let's get an honest look at your starting point. You can't plan a new journey until you know where you are on the map.</p><p class='prompt-example'>For this section, please have your <strong>Sales Scorecard</strong> open. This is your 'cheat sheet' for all your 2025 performance data.</p>" }, // 1
            { id: 'personName', fieldId: 'personName', phase: 1, prompt: "First things first, <strong>what's your full name?</strong>" }, // 2
            { id: 'managerName', fieldId: 'managerName', phase: 1, prompt: "Great. Now, <strong>who is your manager?</strong> This plan is a commitment you'll both work on, so their name is important." }, // 3
            { id: 'region', fieldId: 'region', phase: 1, prompt: "Geography check! <strong>Which region are you primarily responsible for?</strong> (This will customize your workshop content later)." }, // 4
            { id: 'quota2025', fieldId: 'quota2025', phase: 1, prompt: "<h3>Step 1: The Look-Back</h3><p class='prompt-why'>Alright, let's open your <strong>Sales Scorecard</strong>. For the next few steps, you'll be pulling your 2025 numbers from that scorecard. First, what was your <strong>2025 Quota ($)?</strong></p>" }, // 5
            { id: 'bookings2025', fieldId: 'bookings2025', phase: 1, prompt: "<h3>Step 1: The Look-Back</h3><p class='prompt-why'>On that same scorecard, find your <strong>2025 Bookings ($)</strong> (your total closed-won revenue).</p><p class='prompt-example'><strong>Why?</strong> This calculates your 2025 Attainment. This plan is about honesty. Be accurate so we can build a realistic path forward.</p>" }, // 6
            { id: 'winRate2025', fieldId: 'winRate2025', phase: 1, prompt: "<h3>Step 1: The Look-Back</h3><p class='prompt-why'>This is a key one. <strong>Look at your scorecard</strong> for your <strong>2025 Baseline Win Rate (%)</strong>.</p><p class='prompt-example'><strong>Why?</strong> This is your <em>quality & qualification</em> metric. A low rate might mean you're wasting time on unqualified deals.</p>" }, // 7
            { id: 'avgDealSize2025', fieldId: 'avgDealSize2025', phase: 1, prompt: "<h3>Step 1: The Look-Back</h3><p class='prompt-why'>Next, find your <strong>2025 Avg. Deal Size ($)</strong> on your scorecard.</p><p class='prompt-example'><strong>Why?</strong> This is your <em>value</em> metric. Are you selling single products, or are you selling the full 'Connect & Scale' solution? A higher number here means a more efficient sales motion.</p>" }, // 8
            { id: 'avgMeetings2025', fieldId: 'avgMeetings2025', phase: 1, prompt: "<h3>Step 1: The Look-Back</h3><p class='prompt-why'>Last baseline number: Find your <strong>2025 Avg. In-Person Meetings (Quarterly)</strong> on your scorecard's activity tab.</p><p class='prompt-example'><strong>Why?</strong> This is your <em>activity</em> metric. In our complex industries, face-time with customers is directly linked to success.</p>" }, // 9

            // --- Phase 2: See the Gap (Steps 10-15) ---
            { id: 'phase2-welcome', fieldId: null, phase: 2, prompt: "<h3>PHASE 2: SEE THE GAP (Your 2026 Challenge)</h3><p class='prompt-why'>Great, that's your 2025 baseline. You can't set a new course until you know where you're starting from.</p><p class='prompt-why'>Now for Phase 2: let's figure out the <em>size* of your 2026 challenge. Hit <strong>Next</strong> to see the gap.</p>" }, // 10
            { id: 'quota2026', fieldId: 'quota2026', phase: 2, prompt: "<h3>Step 2: The 2026 Formula</h3><p class='prompt-why'>This is the big one: what is your <strong>2026 Quota Commitment ($)?</strong></p><p class='prompt-example'><strong>Why?</strong> Enter your new number. The tool will *immediately* calculate what's required to hit this goal *if you change nothing*. This isn't your plan; it's the *problem* we're about to solve together.</p>" }, // 11
            { id: 'reflection', fieldId: 'reflection', phase: 2, prompt: "<h3>Step 2: The 2026 Formula</h3><p class='prompt-why'>Okay, take a look at those 'Required' numbers. Based on that hard math, <strong>how does your 2026 goal feel right now?</strong></p><p class='prompt-example'><strong>Why?</strong> Be honest. If it feels 'Impossible,' it just means your 2025 efficiency isn't good enough for 2026. That's fine! The next steps are <em>how</em> we fix that.</p>" }, // 12
            { id: 'recommendedCoverage', fieldId: 'recommendedCoverage', phase: 2, prompt: "<h3>Step 3: Your Pipeline Plan</h3><p class='prompt-why'>On your <strong>Sales Scorecard</strong>, you'll see a <strong>Recommended Pipeline Coverage</strong> (like 1.9x or 2.5x). What is that number?</p><p class='prompt-example'><strong>Why?</strong> This number is your *personal* success formula. It's the total pipeline you *actually* need to hit your number. The tool will now calculate your **Total Pipeline Gap** in real dollars.</p>" }, // 13
            { id: 'pipelineMix', fieldId: 'pipelineMix', phase: 2, prompt: "<h3>Step 3: Your Pipeline Plan</h3><p class='prompt-why'>Your scorecard shows your *past* pipeline mix. Let's plan your *future* mix. How will you build your 2026 pipeline? (Must total 100%).</p><p class='prompt-example'><strong>Why?</strong> This forces you to think strategically. To hit your number, you can't just rely on new logos. You *must* have a plan for Cross-selling and Upselling.</p>" }, // 14
            { id: 'pipelineSource', fieldId: 'pipelineSource', phase: 2, prompt: "<h3>Step 3: Your Pipeline Plan</h3><p class='prompt-why'>Your scorecard shows where your pipeline *came from*. Now, plan where it *will come from* in 2026. (Must total 100%).</p><p class='prompt-example'><strong>Why?</strong> This is your accountability pact. If you need 30% from SDRs, you must have a plan to partner with them (we'll get to that in the next section).</p>" }, // 15

            // --- Phase 3: Create the Solution (Steps 16-24) ---
            { id: 'phase3-welcome', fieldId: null, phase: 3, prompt: "<h3>PHASE 3: CREATE THE SOLUTION (Your Action Plan)</h3><p class='prompt-why'>You've seen the data. You've defined the gap. Now for the most important part: <strong>creating your solution.</strong></p><p class='prompt-example'>In this section, you'll first see how small improvements can close your gap. Then, you'll use what you learned in the SKO workshops to write your *specific* action plan.</p>" }, // 16
            { id: 'winRateImprovement', fieldId: 'winRateImprovement', phase: 3, prompt: "<h3>Step 4: How to Improve (The Scenarios)</h3><p class='prompt-why'>Let's find ways to close that gap. First: <strong>Improve your Win Rate (Quality).</strong></p><p class='prompt-example'><strong>Why?</strong> This is your *Quality* plan. Improving your Win Rate means you need <em>less total pipeline</em> to hit your goal. This is about better qualification. Use the slider to see how it affects your 'Pipeline Needed' number.</p>" }, // 17
            { id: 'dealSizeImprovement', fieldId: 'dealSizeImprovement', phase: 3, prompt: "<h3>Step 4: How to Improve (The Scenarios)</h3><p class='prompt-why'>Second: <strong>Improve your Avg. Deal Size (Value).</strong></p><p class='prompt-example'><strong>Why?</strong> This is your *Value* plan. Increasing your Avg. Deal Size means you need to close <em>fewer total deals</em>. This is about selling the full 'Connect & Scale' solution. Use the slider to see its impact.</p>" }, // 18
            { id: 'meetingImprovement', fieldId: 'meetingImprovement', phase: 3, prompt: "<h3>Step 4: How to Improve (The Scenarios)</h3><p class='prompt-why'>And third: <strong>Increase your Avg. Quarterly Meetings (Activity).</strong></p><p class='prompt-example'><strong>Why?</strong> This is your *Activity* plan. Committing to more in-person meetings increases your predictability and builds stronger relationships. Use the slider to commit to a new quarterly number.</p>" }, // 19
            { id: 'primaryGoal', fieldId: 'primaryGoal', phase: 3, prompt: () => { // DYNAMIC
                let region = $('region').value;
                let workshopText = "the <strong>3 Best Practice Workshops</strong> (on Account Planning, Pipeline Hygiene, and Team Selling)."; // Default/APAC
                if (region === 'NA' || region === 'EMEA') {
                    workshopText = "the <strong>3 Best Practice Workshops</strong> (on Account Planning, Cross-Sell Strategies, and Team Selling).";
                }
                return `<h3>Step 5: Your Action Plan (Apply What You've Learned)</h3><p class='prompt-why'>You've seen your data, and you've seen how small improvements can make a huge impact. You also just attended ${workshopText}</p><p class='prompt-why'>This is where you connect those ideas to your numbers. Based on what you learned, <strong>which improvement will be your primary focus in 2026?</strong></p>`;
            }}, // 20
            { id: 'action-people', fieldId: 'action-people', phase: 3, prompt: () => { // DYNAMIC
                let region = $('region').value;
                let workshopExample = "If your data shows a low <strong>Win Rate</strong>, your 'People' action (from the <strong>Pipeline Hygiene</strong> workshop) might be: 'I will learn to disqualify deals earlier to protect my win rate.'";
                if (region === 'NA' || region === 'EMEA') {
                     workshopExample = "If your data shows a low <strong>Cross-Sell Mix</strong>, your 'People' action (from the <strong>Cross-Sell Strategies</strong> workshop) might be: 'I will master the new Tekla/Viewpoint integration to improve my bundle pitch.'";
                }
                return `<h3>Step 5: Your Action Plan (People)</h3><p class='prompt-why'>This is your <strong>'Get Smarter'</strong> plan. What new skill will you learn to close the gap? Think about the SKO sessions you just attended.</p><p class='prompt-example'><strong>Example:</strong> ${workshopExample}</p>`;
            }}, // 21
            { id: 'action-productivity', fieldId: 'action-productivity', phase: 3, prompt: () => { // DYNAMIC
                return `<h3>Step 5: Your Action Plan (Productivity)</h3><p class='prompt-why'>This is your <strong>'Work Smarter'</strong> plan. Think about the <strong>Team Selling, Orchestrating the Sale</strong> workshop. Did your data show that 95% of your pipeline is self-sourced?</p><p class='prompt-example'><strong>How to use this:</strong> Your 'Productivity' action could be: 'I will partner with my SDR to build a Top 10 prospect list to fix my 'SDR-Sourced' gap' or 'I will use the new CRM tool to automate my follow-ups.'</p>`;
            }}, // 22
            { id: 'action-forecast', fieldId: 'action-forecast', phase: 3, prompt: "<h3>Step 5: Your Commitment</h3><p class='prompt-why'>Predictability is critical. Your commitment is a <strong>95-105% accurate forecast</strong>. What is the Key Action you will take to ensure this?</p><p class='prompt-example'><strong>Example:</strong> 'I will 'murder-board' my own commit list before submitting my forecast' or 'I will review my pipeline daily for data hygiene.'</p>" }, // 23
            { id: 'action-account-plan', fieldId: 'action-account-plan', phase: 3, prompt: () => { // DYNAMIC
                return `<h3>Step 5: Your Commitment</h3><p class='prompt-why'>You just set your new <strong>Cross-sell/Upsell Mix</strong> goals. The <strong>Account Planning & Territory Management</strong> workshop gave you the 'how'. Now, write your specific commitment.</p><p class='prompt-example'><strong>Example:</strong> 'I will build a 4-quarter strategic plan for my Top 10 accounts by Feb 1st, focusing on two cross-sell opportunities for each.'</p>`;
            }}, // 24
            
            // --- Phase 4: Review (Step 25) ---
            { id: 'review', fieldId: 'review', phase: 4, prompt: "<h3>✅ Step 6: Final Review & Submission</h3><p class='prompt-why'>This is it! Your 2026 Commitment Plan is complete. Please review the summary below one last time.</p><hr class='my-4'><p class='prompt-why'><strong>1. For your Manager (Required):</strong><br>Click <strong>Export JSON Data</strong>. This saves a small data file. Please email this file to your manager for team compilation.</p><p class='prompt-why mt-4'><strong>2. For You (Final Step):</strong><br>Click <strong>Save as PDF</strong> to keep a personal, printable copy of your full commitment.</p>", group: $('group-review') } // 25
        ];
        
        let currentStepIndex = 0;
        
        // --- Validation Logic ---
        function validateField(fieldId) {
            const input = $(fieldId);
            const errorElement = $(`error-${fieldId}`);
            const value = getStringValue(fieldId);
            
            let isValid = true;
            let isNumeric = input && input.classList.contains('numeric-field');
            let numValue = isNumeric ? getNumberValue(fieldId) : 0;
    
            if (input) input.classList.remove('error');
            if (errorElement) errorElement.classList.add('hidden');
    
            if (input && input.classList.contains('required-field') && !value) {
                isValid = false;
            } 
            else if (isNumeric && (numValue <= 0 || !isFinite(numValue))) {
                if (fieldId !== 'bookings2025' && fieldId !== 'meetingsImpliedWinRate_visible' && fieldId !== 'recommendedCoverage') {
                    isValid = false;
                }
            }
            else if (fieldId === 'winRate2025' && (numValue < 0 || numValue > 100)) {
                isValid = false;
            }
    
            if (input && input.classList.contains('required-radio')) {
                const radioName = input.name;
                if (!getSelectedValue(radioName)) {
                    const radioError = $(`error-${radioName}`);
                    if (radioError) radioError.classList.remove('hidden');
                    isValid = false;
                }
            }
            
            if (fieldId === 'pipelineMix') {
                const total = getNumberValue('mixNewLogo') + getNumberValue('mixCrossSell') + getNumberValue('mixUpsell');
                if (total !== 100) {
                    if (errorElement) errorElement.classList.remove('hidden');
                    isValid = false;
                }
            }
            if (fieldId === 'pipelineSource') {
                const total = getNumberValue('sourceSelf') + getNumberValue('sourceSDR') + getNumberValue('sourceMarketing');
                if (total !== 100) {
                    if (errorElement) errorElement.classList.remove('hidden');
                    isValid = false;
                }
            }

            if (!isValid) {
                if (input) input.classList.add('error');
                if (errorElement) errorElement.classList.remove('hidden');
            }
    
            return isValid;
        }
        
        function validateCurrentStep() {
            const step = steps[currentStepIndex];
            const fieldId = step.fieldId;
            
            if (!fieldId) return true; // Intro/Review/Phase Welcome
    
            if (fieldId.includes('action-') || fieldId === 'primaryGoal') {
                 const requiredGroupFields = document.querySelectorAll(`#group-${step.fieldId} .required-field, #group-${step.fieldId} .required-radio`);
                 let groupValid = true;
                 requiredGroupFields.forEach(field => {
                     if (!validateField(field.id)) {
                         groupValid = false;
                     }
                 });
                 return groupValid;
            } else if (fieldId === 'reflection') {
                 return !!getSelectedValue('reflection');
            } else if (fieldId === 'pipelineMix' || fieldId === 'pipelineSource') {
                 return validateField(fieldId); // Use the special group validator
            } else {
                return validateField(fieldId);
            }
        }
    
    
        // --- Core Calculation Function ---
        function calculatePlan() {
            // Step 1
            const quota2025 = getNumberValue('quota2025');
            const bookings2025 = getNumberValue('bookings2025');
            const winRate2025 = getNumberValue('winRate2025');
            const avgDealSize2025 = getNumberValue('avgDealSize2025');
            const avgMeetings2025 = getNumberValue('avgMeetings2025');
            // Step 2
            const quota2026 = getNumberValue('quota2026');
            // Step 3
            const recommendedCoverage = getNumberValue('recommendedCoverage');
            // Step 4
            const winRateImprovement = getNumberValue('winRateImprovement');
            const dealSizeImprovement = getNumberValue('dealSizeImprovement');
            const meetingImprovement = getNumberValue('meetingImprovement');
            
            const meetingsImpliedWinRateVisible = getNumberValue('meetingsImpliedWinRate_visible');
            const meetingsImpliedWinRateHidden = $('meetingsImpliedWinRate');
            if(meetingsImpliedWinRateHidden) meetingsImpliedWinRateHidden.value = meetingsImpliedWinRateVisible;
            const meetingsImpliedWinRate = meetingsImpliedWinRateVisible;
    
            // Step 1 Calc
            const attainment2025 = quota2025 > 0 ? (bookings2025 / quota2025) * 100 : 0;
            if($('attainment2025')) $('attainment2025').textContent = formatPercent(attainment2025);
    
            // Step 2 Calc
            const winRateDecimal = winRate2025 / 100;
            const pipelineToClose2026 = winRateDecimal > 0 ? quota2026 / winRateDecimal : 0;
            const dealsToClose2026 = avgDealSize2025 > 0 ? pipelineToClose2026 / avgDealSize2025 : 0;
            
            if($('pipelineToClose2026')) $('pipelineToClose2026').textContent = formatCurrency(pipelineToClose2026);
            if($('dealsToClose2026')) $('dealsToClose2026').textContent = formatNumber(dealsToClose2026);
            
            window.planData.pipelineToClose2026 = pipelineToClose2026;
            window.planData.dealsToClose2026 = dealsToClose2026;

            // Step 3 Calc (Gap)
            const totalPipelineNeeded = quota2026 * recommendedCoverage;
            const pipelineGap = totalPipelineNeeded; // Simplified for now.
            if($('pipelineGap')) $('pipelineGap').textContent = formatCurrency(pipelineGap);
            window.planData.pipelineGap = pipelineGap;
    
            // Step 4 Calc (Scenarios)
            const newWinRate = winRate2025 + winRateImprovement;
            const newWinRateDecimal = newWinRate / 100;
            const newPipelineNeeded = newWinRateDecimal > 0 ? quota2026 / newWinRateDecimal : 0;
            
            if($('winRateImprovementLabel')) $('winRateImprovementLabel').textContent = `${winRateImprovement.toFixed(1)}%`;
            if($('newWinRateLabel')) $('newWinRateLabel').textContent = formatPercent(newWinRate);
            if($('newPipelineNeeded')) $('newPipelineNeeded').textContent = formatCurrency(newPipelineNeeded);
    
            const newAvgDealSize = avgDealSize2025 * (1 + (dealSizeImprovement / 100));
            const newDealsNeeded = newAvgDealSize > 0 ? quota2026 / newAvgDealSize : dealsToClose2026;
            
            if($('dealSizeImprovementLabel')) $('dealSizeImprovementLabel').textContent = `${dealSizeImprovement.toFixed(0)}%`;
            if($('newAvgDealSizeLabel')) $('newAvgDealSizeLabel').textContent = formatCurrency(newAvgDealSize);
            if($('newDealsNeeded')) $('newDealsNeeded').textContent = formatNumber(newDealsNeeded);
            
            const newMeetingAvg = avgMeetings2025 + meetingImprovement;
            const meetingsImpliedWinRateDecimal = meetingsImpliedWinRate / 100;
            const meetingsPipelineNeeded = meetingsImpliedWinRateDecimal > 0 ? quota2026 / meetingsImpliedWinRateDecimal : pipelineToClose2026;
            
            if($('meetingImprovementLabel')) $('meetingImprovementLabel').textContent = `${meetingImprovement.toFixed(0)}`;
            if($('newMeetingAvgLabel')) $('newMeetingAvgLabel').textContent = `${newMeetingAvg.toFixed(0)}`;
            if($('meetingsPipelineNeeded')) $('meetingsPipelineNeeded').textContent = formatCurrency(meetingsPipelineNeeded);
            
            const finalTargetWinRate = Math.max(newWinRate, meetingsImpliedWinRate);
            window.planData.finalTargetWinRate = finalTargetWinRate;
            window.planData.finalTargetPipeline = finalTargetWinRate > 0 ? quota2026 / (finalTargetWinRate / 100) : pipelineToClose2026;
    
            if (steps[currentStepIndex].id === 'review') generateCommitmentSummary();
        }
    
        // --- Summary Generation ---
        function generateCommitmentSummary() {
            const personName = getStringValue('personName');
            const managerName = getStringValue('managerName');
            const region = $('region').value || '[Not Provided]';
            const reflection = getSelectedLabel('reflection');
            const goalSelection = getSelectedLabel('primaryGoal');
            
            const winRate2025 = getNumberValue('winRate2025');
            const avgDealSize2025 = getNumberValue('avgDealSize2025');
            const attainment2025 = $('attainment2025').textContent;
            const quota2026 = formatCurrency(getNumberValue('quota2026'));
            
            const recommendedCoverage = getNumberValue('recommendedCoverage');
            const pipelineGap = formatCurrency(window.planData.pipelineGap || 0);

            const targetWinRate = formatPercent(window.planData.finalTargetWinRate || winRate2025);
            const targetDealSize = $('newAvgDealSizeLabel').textContent;
            const targetPipeline = formatCurrency(window.planData.finalTargetPipeline || 0);
            
            const actions = {
                people: getStringValue('action-people'),
                productivity: getStringValue('action-productivity'),
                forecast: getStringValue('action-forecast'),
                accountPlan: getStringValue('action-account-plan'),
            };
    
            const summaryText = `
TRIMBLE 2026 SALES COMMITMENT PLAN (FINAL)

1. Personal & Financial Baseline
- Rep: ${personName}
- Manager: ${managerName}
- Region: ${region}
- 2026 Quota Commitment: ${quota2026}
- 2025 Attainment: ${attainment2025}
- 2025 Baseline Win Rate: ${winRate2025}%
- 2025 Baseline Avg. Deal Size: ${formatCurrency(avgDealSize2025)}

2. Pipeline Plan
- Recommended Coverage: ${recommendedCoverage}x
- Total Pipeline Gap: ${pipelineGap}
- Pipeline Mix: ${getNumberValue('mixNewLogo')}% New Logo, ${getNumberValue('mixCrossSell')}% Cross-Sell, ${getNumberValue('mixUpsell')}% Upsell
- Pipeline Source: ${getNumberValue('sourceSelf')}% Self, ${getNumberValue('sourceSDR')}% SDR, ${getNumberValue('sourceMarketing')}% Marketing

3. Strategy & Targets (Scenarios)
- Overall Reflection: ${reflection}
- Primary Focus Lever: ${goalSelection}
- COMMITTED TARGETED WIN RATE: ${targetWinRate} 
- Targeted Avg. Deal Size: ${targetDealSize}
- Target Pipeline Required (After Gains): ${targetPipeline} (Goal)

4. Key Action Plan (PEOPLE, PIPELINE & PRODUCTIVITY)
- PEOPLE Commitment: ${actions.people}
- PRODUCTIVITY Commitment: ${actions.productivity}
- Forecasting Action: ${actions.forecast}
- Account Planning: ${actions.accountPlan}

---
Generated by the Trimble 2026 Success Planner.
            `.trim();
            
            $('commitmentSummaryOutput').textContent = summaryText;
            return summaryText;
        }
    
        // --- JSON Export ---
        function generateJSONData() {
            calculatePlan(); 
            
            const metadata = {
                plan_version: "2026.16-Friendly-Phases", // New version tag
                date_exported: new Date().toISOString(),
                rep_name: getStringValue('personName'),
                manager_name: getStringValue('managerName'),
                region: $('region').value || 'Unknown',
                quota_2025: getNumberValue('quota2025'),
                bookings_2025: getNumberValue('bookings2025'),
            };
    
            const inputs = {
                quota_2026: getNumberValue('quota2026'),
                win_rate_2025: getNumberValue('winRate2025'),
                avg_deal_size_2025: getNumberValue('avgDealSize2025'),
                meetings_2025_avg: getNumberValue('avgMeetings2025'),
                
                lever_selected: getSelectedValue('primaryGoal'),
                reflection: getSelectedValue('reflection'),
                
                pipeline_plan: {
                    recommended_coverage: getNumberValue('recommendedCoverage'),
                    pipeline_gap: window.planData.pipelineGap || 0,
                    mix_new_logo_pct: getNumberValue('mixNewLogo'),
                    mix_cross_sell_pct: getNumberValue('mixCrossSell'),
                    mix_upsell_pct: getNumberValue('mixUpsell'),
                    source_self_pct: getNumberValue('sourceSelf'),
                    source_sdr_pct: getNumberValue('sourceSDR'),
                    source_marketing_pct: getNumberValue('sourceMarketing'),
                },

                scenarios: {
                    win_rate_improvement_pct: getNumberValue('winRateImprovement'),
                    deal_size_improvement_pct: getNumberValue('dealSizeImprovement'),
                    meetings_increase_abs: getNumberValue('meetingImprovement'),
                    implied_win_rate_l3: getNumberValue('meetingsImpliedWinRate'),
                },
    
                harmonized_targets: {
                    win_rate_target_pct: window.planData.finalTargetWinRate || getNumberValue('winRate2025'), 
                    deal_size_target_value: getNumberValue('avgDealSize2025') * (1 + (getNumberValue('dealSizeImprovement') / 100)),
                    pipeline_required_target: window.planData.finalTargetPipeline || 0
                }
            };
    
            const actions = {
                people: getStringValue('action-people'),
                productivity: getStringValue('action-productivity'),
                forecast: getStringValue('action-forecast'),
                account_plan: getStringValue('action-account-plan'),
            };
    
            return { metadata, inputs, actions };
        }
    
        // --- Wizard Logic ---
        function showStep(stepIndex) {
            document.querySelectorAll('.form-group').forEach(group => {
                group.style.display = 'none';
            });
            document.querySelectorAll('.error-message').forEach(error => {
                error.classList.add('hidden');
            });
            
            currentStepIndex = stepIndex;
            const step = steps[stepIndex];
            const currentPhase = step.phase;

            // Update Progress Bar
            for (let i = 1; i <= 6; i++) { // UPDATED to 6 segments
                const seg = $(`progress-${i}`);
                seg.classList.remove('active', 'complete');
                if (i < currentPhase) {
                    seg.classList.add('complete');
                } else if (i === currentPhase) {
                    seg.classList.add('active');
                }
            }
            
            // Update Conversation Bubble
            const bubble = $('conversation-bubble');
            bubble.classList.remove('phase-1-bubble', 'phase-2-bubble', 'phase-3-bubble', 'phase-4-bubble', 'phase-5-bubble', 'phase-6-bubble');
            bubble.classList.add(`phase-${currentPhase}-bubble`);

            if (typeof step.prompt === 'function') {
                bubble.innerHTML = step.prompt();
            } else {
                bubble.innerHTML = step.prompt;
            }
    
            // Show correct form group
            const groupElements = document.querySelectorAll(`#group-${step.fieldId}`);
            groupElements.forEach(el => {
                el.style.display = 'block';
            });
            
            // Special case: Lever groups (17, 18, 19) are grouped
            if (stepIndex >= 17 && stepIndex <= 19) {
                $('group-winRateImprovement').style.display = 'block';
                $('group-dealSizeImprovement').style.display = 'block';
                $('group-meetingImprovement').style.display = 'block';
            }
    
            const isReviewStep = step.id === 'review';
            if (isReviewStep) generateCommitmentSummary();
    
            $('prevButton').style.display = stepIndex > 0 ? 'inline-block' : 'none';
            $('nextButton').style.display = isReviewStep ? 'none' : 'inline-block';
            
            const finalActionsVisible = isReviewStep;
            $('exportJSONButton').style.display = finalActionsVisible ? 'inline-block' : 'none';
            $('copyCommitmentButton').style.display = finalActionsVisible ? 'inline-block' : 'none';
            $('printButton').style.display = finalActionsVisible ? 'inline-block' : 'none';
    
            const currentInput = step.fieldId ? $(step.fieldId) || document.querySelector(`#group-${step.fieldId} input, #group-${step.fieldId} select, #group-${step.fieldId} textarea`) : null;
            if (currentInput) currentInput.focus();
    
            updateNextButtonState();
        }
    
        function updateNextButtonState() {
            const nextButton = $('nextButton');
            if (!nextButton || steps[currentStepIndex].id === 'review') return;
            
            // Scenario steps (17-19) do not have mandatory validation
            if (currentStepIndex >= 17 && currentStepIndex <= 19) {
                nextButton.disabled = false;
                return;
            }
    
            const isValid = validateCurrentStep();
            nextButton.disabled = !isValid;
        }
    
        function nextStep() {
            // Special case for Lever grouping
            if (currentStepIndex >= 17 && currentStepIndex <= 19) {
                 currentStepIndex = 20; // Skip directly to Primary Goal
                 showStep(currentStepIndex);
                 return;
            }
            
            if (validateCurrentStep()) {
                if (currentStepIndex < steps.length - 1) {
                    currentStepIndex++;
                    showStep(currentStepIndex);
                }
            }
        }
    
        function previousStep() {
            if (currentStepIndex > 0) {
                // New 6-phase logic
                if (currentStepIndex > 20) { // If on any action step
                     currentStepIndex = 20; // Go back to Primary Goal
                } else if (currentStepIndex >= 17 && currentStepIndex <= 19) { // If on Scenarios
                    currentStepIndex = 16; // Go back to Phase 3 Welcome
                } else if (currentStepIndex == 16) { // If on Phase 3 Welcome
                    currentStepIndex = 15; // Go back to Sourcing
                } else if (currentStepIndex == 10) { // If on Phase 2 Welcome
                    currentStepIndex = 9; // Go back to Avg Meetings
                } else if (currentStepIndex == 1) { // If on Phase 1 Welcome
                    currentStepIndex = 0; // Go back to Intro
                }
                else {
                    currentStepIndex--;
                }
                showStep(currentStepIndex);
            }
        }
    
        // --- Data Download & Copy Handlers ---
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                const button = $('copyCommitmentButton');
                const originalText = button.textContent;
                
                button.textContent = 'COPIED!';
                setTimeout(() => {
                    button.textContent = originalText;
                }, 1500);
            }).catch(err => {
                alert("Failed to copy text. Please manually copy the text from the box above.");
            });
        }
    
        function downloadJSON(data, filename) {
            const json = JSON.stringify(data, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            
            const inputsToTrack = [
                'quota2025', 'bookings2025', 'avgDealSize2025', 'region', 'personName', 'managerName', 'avgMeetings2025',
                'quota2026', 'recommendedCoverage',
                'mixNewLogo', 'mixCrossSell', 'mixUpsell',
                'sourceSelf', 'sourceSDR', 'sourceMarketing',
                'winRateImprovement', 'dealSizeImprovement', 'meetingsImpliedWinRate_visible',
                'action-people', 'action-productivity', 'action-forecast', 'action-account-plan'
            ];
            
            inputsToTrack.forEach(id => {
                const el = $(id);
                if (el) {
                    const changeHandler = () => {
                        calculatePlan();
                        updateNextButtonState();
                    };
                    el.addEventListener('input', changeHandler);
                    el.addEventListener('change', changeHandler);

                    if (el.tagName !== 'TEXTAREA' && el.type !== 'range') {
                        el.addEventListener('keydown', (event) => {
                            if (event.key === 'Enter') {
                                event.preventDefault();
                                $('nextButton').click(); // Simulate click to trigger validation
                            }
                        });
                    }
                }
            });
            
            const radioNames = ['reflection', 'primaryGoal'];
            radioNames.forEach(name => {
                document.querySelectorAll(`input[name="${name}"]`).forEach(radio => {
                    const radioChangeHandler = () => {
                        calculatePlan();
                        updateNextButtonState();
                    };
                    radio.addEventListener('change', radioChangeHandler);
                    
                     radio.addEventListener('keydown', (event) => {
                        if (event.key === 'Enter') {
                            event.preventDefault(); 
                            radio.checked = true;
                            radio.dispatchEvent(new Event('change'));
                            setTimeout(() => $('nextButton').click(), 100); 
                        }
                    });
                });
            });
    
            $('nextButton').addEventListener('click', nextStep);
            $('prevButton').addEventListener('click', previousStep);
            
            $('resetButton').addEventListener('click', () => {
                if(confirm("Are you sure you want to start over? All entered data will be lost.")) {
                    if($('skoForm')) $('skoForm').reset();
                    calculatePlan();
                    showStep(0);
                    if($('main-heading')) $('main-heading').focus();
                }
            });
    
            $('printButton').addEventListener('click', () => {
                if (confirm("Is this your final, correct plan? This will prepare a PDF copy for your records.")) {
                    window.print();
                }
            });
            
            $('copyCommitmentButton').addEventListener('click', () => {
                const summary = generateCommitmentSummary();
                copyToClipboard(summary);
            });
            
            $('exportJSONButton').addEventListener('click', () => {
                const data = generateJSONData();
                const repName = getStringValue('personName') || 'SalesRep';
                const fileName = `Trimble_2026_Plan_${repName.replace(/\s/g, '_')}.json`;
                downloadJSON(data, fileName);
            });
    
            calculatePlan();
            showStep(0);
        });
    </script>

</body>
</html>
