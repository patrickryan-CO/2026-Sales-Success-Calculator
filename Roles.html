<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trimble 2026 Success Plan</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#0063a3',      // Trimble Blue
                        'primary-hover': '#004a7c',
                        'accent': '#fbad26',       // Trimble Yellow
                        'primary-text': '#252a2e', // Dark Gray (Headings)
                        'soft-bg': '#f3f6f9',      // Light Gray
                        'error-red': '#e11d48',    // Softer Red
                    },
                    fontFamily: {
                        'sans': ['Open Sans', 'sans-serif']
                    }
                }
            }
        }
    </script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        /* BASE STYLES */
        body {
            font-family: 'Open Sans', sans-serif;
            color: #252a2e; 
            background-color: #f3f6f9;
        }
        
        /* FRIENDLY GUIDE BOX */
        .guide-box {
            @apply bg-blue-50 border-l-4 border-primary text-primary-text p-4 mb-8 rounded-r-md text-sm leading-relaxed;
        }

        /* ANIMATED TOOLTIPS */
        .tooltip-container {
            position: relative;
            display: inline-block;
            margin-left: 8px;
            vertical-align: middle;
            z-index: 50;
            line-height: 1.2;
        }
        
        .tooltip-trigger {
            display: inline-flex; align-items: center; justify-content: center;
            width: 20px; height: 20px;
            background-color: #d1d5db; color: white; border-radius: 50%;
            cursor: help; transition: background-color 0.2s;
            font-size: 12px; font-weight: bold;
        }
        
        .tooltip-trigger:hover {
            background-color: #0063a3;
        }
        
        .tooltip-popup {
            visibility: hidden; opacity: 0;
            position: absolute; bottom: 130%; left: 50%;
            transform: translateX(-50%) translateY(5px);
            background-color: #1f2937; color: white;
            text-align: center; padding: 10px 14px;
            border-radius: 6px; font-size: 0.75rem; font-weight: 500;
            line-height: 1.4; white-space: normal; width: 220px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease-out;
            pointer-events: none;
        }
        
        .tooltip-popup::after {
            content: ""; position: absolute; top: 100%; left: 50%;
            margin-left: -5px; border-width: 5px;
            border-style: solid;
            border-color: #1f2937 transparent transparent transparent;
        }
        
        .tooltip-container:hover .tooltip-popup {
            visibility: visible; opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        /* INPUT FIELDS */
        .input-label {
            display: flex; align-items: center;
            font-size: 0.9rem; font-weight: 700; color: #374151; margin-bottom: 0.5rem;
        }
        .input-field {
            display: block; width: 100%;
            border-radius: 0.5rem; border: 1px solid #d1d5db;
            padding: 0.75rem 1rem; font-size: 1rem;
            transition: all 0.2s;
        }
        .input-field:focus {
            outline: none; border-color: #0063a3; ring: 3px; ring-color: #e0f2fe;
            box-shadow: 0 0 0 3px rgba(0, 99, 163, 0.1);
        }
        
        /* VALIDATION STATES */
        .input-error {
            border-color: #e11d48 !important;
            background-color: #fff1f2;
        }
        .error-text {
            display: none; color: #e11d48; font-size: 0.8rem; margin-top: 0.4rem; font-weight: 600;
        }
        .error-text.show { display: block; animation: fadeIn 0.3s; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

        /* SWOOP HEADER */
        .header-swoop {
            background-color: #0063a3;
            width: 100%; height: 220px;
            position: absolute; top: 0; left: 0; z-index: 0;
            overflow: hidden;
        }
        .header-swoop svg {
            width: 100%; height: 100%;
            position: absolute; bottom: -1px; left: 0;
        }

        /* PROGRESS TABS */
        .progress-container {
            display: flex; border-bottom: 1px solid #e5e7eb; margin-bottom: 0;
        }
        .progress-step {
            flex: 1; text-align: center; padding: 1rem;
            font-size: 0.8rem; font-weight: 700; color: #9ca3af; letter-spacing: 0.05em;
            border-bottom: 4px solid transparent; transition: all 0.3s;
        }
        .progress-step.active {
            color: #0063a3; border-bottom-color: #0063a3;
        }
        .progress-step.completed {
            color: #0063a3; opacity: 0.6;
        }

        /* BUTTONS */
        .btn {
            padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600;
            transition: all 0.2s; cursor: pointer; text-align: center;
        }
        .btn-primary { background-color: #0063a3; color: white; box-shadow: 0 4px 6px -1px rgba(0, 99, 163, 0.2); }
        .btn-primary:hover { background-color: #004a7c; transform: translateY(-1px); box-shadow: 0 6px 8px -1px rgba(0, 99, 163, 0.3); }
        .btn-accent { background-color: #fbad26; color: #252a2e; }
        .btn-accent:hover { background-color: #e59b1a; }
        .btn-ghost { background-color: transparent; color: #6b7280; }
        .btn-ghost:hover { background-color: #f3f4f6; color: #1f2937; }

        /* Print adjustments */
        @media print {
            .header-swoop, .tooltip-container, #nav-area { display: none !important; }
            body { background: white; }
            .shadow-2xl { box-shadow: none; }
            .step-panel { display: block !important; }
            .hidden { display: block !important; }
            #step-0, #step-1 { display: none !important; }
        }
    </style>
</head>
<body>

    <div class="header-swoop">
        <svg viewbox="0 0 1440 320" preserveAspectRatio="none">
            <path fill="#0063a3" fill-opacity="1" d="M0,0L1440,0L1440,220L0,220Z"></path>
            <path fill="#f3f6f9" fill-opacity="1" d="M0,220L60,213.3C120,207,240,193,360,197.3C480,202,600,224,720,229.3C840,235,960,224,1080,208C1200,192,1320,171,1380,160L1440,149L1440,320L1380,320C1320,320,1200,320,1080,320C960,320,840,320,720,320C600,320,480,320,360,320C240,320,120,320,60,320L0,320Z"></path>
        </svg>
    </div>

    <div class="relative z-10 max-w-5xl mx-auto mt-16 mb-12 px-4">
        
        <div class="bg-white rounded-xl shadow-2xl min-h-[650px] flex flex-col relative">
            
            <div class="p-8 pb-0 text-center rounded-t-xl bg-white">
                <h1 class="text-3xl font-extrabold text-primary-text mb-2">Trimble 2026 Success Plan</h1>
                <p class="text-gray-500 font-medium">Own Your Number. Build Your Path.</p>
            </div>

            <div id="progress-bar" class="progress-container mt-8 px-8 hidden">
                <div id="tab-baseline" class="progress-step">1. BASELINE</div>
                <div id="tab-gap" class="progress-step">2. OPPORTUNITY</div>
                <div id="tab-solution" class="progress-step">3. SOLUTION</div>
                <div id="tab-review" class="progress-step">4. REVIEW</div>
            </div>

            <div class="p-8 flex-grow">
                <form id="appForm" onsubmit="return false;">

                    <div id="step-0" class="step-content">
                        <div class="text-center max-w-3xl mx-auto space-y-8">
                            
                            <div class="prose max-w-none text-gray-600">
                                <h2 class="text-2xl font-bold text-gray-800 mb-4">Your Plan. Your Year.</h2>
                                <p class="text-lg leading-relaxed">
                                    Success isn't just about hitting a target; it's about having a clear path to get there. 
                                    We built this tool to help you translate your 2026 goals into a personal roadmap you can own.
                                </p>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-8 text-left">
                                <div class="bg-blue-50 p-6 rounded-lg border border-blue-100">
                                    <div class="text-primary text-2xl mb-2">üë•</div>
                                    <h3 class="font-bold text-gray-800 mb-2">People</h3>
                                    <p class="text-sm text-gray-600">Identify the skills and coaching you need to level up.</p>
                                </div>
                                <div class="bg-blue-50 p-6 rounded-lg border border-blue-100">
                                    <div class="text-primary text-2xl mb-2">üìà</div>
                                    <h3 class="font-bold text-gray-800 mb-2">Pipeline</h3>
                                    <p class="text-sm text-gray-600">Calculate the exact coverage required to hit your number.</p>
                                </div>
                                <div class="bg-blue-50 p-6 rounded-lg border border-blue-100">
                                    <div class="text-primary text-2xl mb-2">‚ö°</div>
                                    <h3 class="font-bold text-gray-800 mb-2">Productivity</h3>
                                    <p class="text-sm text-gray-600">Commit to working smarter with the right tools.</p>
                                </div>
                            </div>

                            <div class="bg-gray-50 rounded-lg p-6 text-left border border-gray-200 mt-8">
                                <h3 class="font-bold text-primary mb-2">What You'll Need:</h3>
                                <div class="text-sm text-gray-600 mb-0 space-y-2">
                                    <p>
                                        <strong>If you have a Sales Scorecard:</strong> Please verify you have access to your 2025 Quota, Bookings, and Win Rate.
                                    </p>
                                    <p>
                                        <strong>If your role doesn't use a scorecard:</strong> Don't worry. You can still use this tool to set objectives and build your action plan.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="step-1" class="step-content hidden">
                        <div class="max-w-xl mx-auto text-center py-10">
                            <h2 class="text-2xl font-bold text-gray-800 mb-4">Let's customize your plan.</h2>
                            <p class="text-gray-600 mb-8">Select your primary role below so we can adjust the metrics to match your business.</p>
                            
                            <div class="text-left bg-white p-8 rounded-lg border border-gray-200 shadow-sm">
                                <label class="input-label text-lg mb-2">I am a:</label>
                                <select id="userRole" class="input-field text-lg py-3 cursor-pointer bg-gray-50">
                                    <option value="AE">Account Executive (AE)</option>
                                    <option value="SDR">Sales Development (SDR)</option>
                                    <option value="SE">Sales Engineer (SE)</option>
                                    <option value="ECOMM">eCommerce</option>
                                    <option value="COMPLIANCE">Compliance / Ops</option>
                                </select>
                            </div>

                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 mt-8 text-left">
                                <h3 class="text-md font-bold text-primary mb-2">Data You Will Need:</h3>
                                <ul class="list-disc list-inside text-sm text-gray-700 space-y-1" id="dynamic-req-list">
                                    </ul>
                            </div>
                        </div>
                    </div>

                    <div id="step-2" class="step-content hidden">
                        <div class="guide-box">
                            <h3 class="font-bold mb-1">YOUR GUIDE: Establishing the Baseline</h3>
                            <p>We can't build a path forward without knowing where we stand. Please enter your <strong>2025 actuals</strong>. This calculates your personal efficiency baseline.</p>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="input-label">My Name</label>
                                <input type="text" id="personName" class="input-field required" placeholder="First and Last Name">
                                <p class="error-text">Please help us identify you.</p>
                            </div>
                            <div>
                                <label class="input-label">My Manager</label>
                                <input type="text" id="managerName" class="input-field required" placeholder="Manager Name">
                                <p class="error-text">Required for the report.</p>
                            </div>
                            <div class="md:col-span-2">
                                <label class="input-label">My Region</label>
                                <select id="region" class="input-field required">
                                    <option value="" disabled selected>Select Region...</option>
                                    <option value="NA">North America</option>
                                    <option value="EMEA">EMEA</option>
                                    <option value="APAC">APAC</option>
                                </select>
                                <p class="error-text">Please select your region.</p>
                            </div>

                            <div>
                                <label class="input-label">
                                    <span id="lbl-quota25">2025 Quota</span>
                                    <div class="tooltip-container">
                                        <span class="tooltip-trigger">?</span>
                                        <div id="tip-quota25" class="tooltip-popup">...</div>
                                    </div>
                                </label>
                                <input type="text" id="val-quota25" class="input-field required" placeholder="0">
                                <p class="error-text">Please add this value.</p>
                            </div>

                            <div>
                                <label class="input-label">
                                    <span id="lbl-actual25">2025 Actuals</span>
                                    <div class="tooltip-container">
                                        <span class="tooltip-trigger">?</span>
                                        <div id="tip-actual25" class="tooltip-popup">...</div>
                                    </div>
                                </label>
                                <input type="text" id="val-actual25" class="input-field required" placeholder="0">
                                <p class="error-text">Please add this value.</p>
                            </div>

                            <div>
                                <label class="input-label">
                                    <span id="lbl-efficiency25">Win Rate %</span>
                                    <div class="tooltip-container">
                                        <span class="tooltip-trigger">?</span>
                                        <div id="tip-efficiency25" class="tooltip-popup">...</div>
                                    </div>
                                </label>
                                <div class="relative">
                                    <input type="number" id="val-efficiency25" class="input-field pr-8 required" placeholder="0">
                                    <span class="absolute right-3 top-3 text-gray-400 font-bold">%</span>
                                </div>
                                <p class="error-text">Please add this value.</p>
                            </div>

                            <div>
                                <label class="input-label">
                                    <span id="lbl-dealSize25">Avg Deal Size</span>
                                    <div class="tooltip-container">
                                        <span class="tooltip-trigger">?</span>
                                        <div id="tip-dealSize25" class="tooltip-popup">...</div>
                                    </div>
                                </label>
                                <input type="text" id="val-dealSize25" class="input-field required" placeholder="0">
                                <p class="error-text">Please add this value.</p>
                            </div>

                            <div class="md:col-span-2 mt-2">
                                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 flex items-center justify-between">
                                    <span class="text-sm font-bold text-gray-600 uppercase tracking-wide">2025 Attainment</span>
                                    <span id="calc-attainment" class="text-2xl font-extrabold text-primary">0%</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="step-3" class="step-content hidden">
                        <div class="guide-box">
                            <h3 class="font-bold mb-1">YOUR GUIDE: The 2026 Opportunity</h3>
                            <p>Now, enter your <strong>2026 Target</strong>. based on your baseline efficiency, we'll calculate what it will take to hit this new number.</p>
                        </div>

                        <div id="calc-section">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                                <div>
                                    <label class="input-label">
                                        <span id="lbl-quota26">2026 Quota</span>
                                        <div class="tooltip-container">
                                            <span class="tooltip-trigger">?</span>
                                            <div id="tip-quota26" class="tooltip-popup">Your new target for the coming year.</div>
                                        </div>
                                    </label>
                                    <input type="text" id="val-quota26" class="input-field required text-lg font-semibold text-primary" placeholder="0">
                                    <p class="error-text">Please enter your new target.</p>
                                </div>
                                
                                <div class="bg-blue-50 border border-blue-100 rounded-lg p-6 md:row-span-2">
                                    <h4 class="text-xs font-bold text-gray-500 uppercase tracking-wide mb-4">Required to Hit Goal</h4>
                                    
                                    <div class="mb-6">
                                        <span id="lbl-resultA" class="block text-sm text-gray-600 mb-1 font-bold">Pipeline Needed</span>
                                        <span id="calc-resultA" class="block text-3xl font-extrabold text-primary">0</span>
                                    </div>
                                    
                                    <div>
                                        <span id="lbl-resultB" class="block text-sm text-gray-600 mb-1 font-bold">Deals Needed</span>
                                        <span id="calc-resultB" class="block text-3xl font-extrabold text-primary">0</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="mt-8">
                            <label class="input-label mb-3">Reflection: Looking at these requirements, how does this goal feel?</label>
                            <div class="grid grid-cols-3 gap-4">
                                <label class="cursor-pointer">
                                    <input type="radio" name="reflection" value="Achievable" class="peer sr-only">
                                    <div class="p-3 text-center border rounded-md hover:bg-gray-50 peer-checked:border-primary peer-checked:bg-blue-50 peer-checked:text-primary transition">
                                        Achievable
                                    </div>
                                </label>
                                <label class="cursor-pointer">
                                    <input type="radio" name="reflection" value="Stretch" class="peer sr-only">
                                    <div class="p-3 text-center border rounded-md hover:bg-gray-50 peer-checked:border-primary peer-checked:bg-blue-50 peer-checked:text-primary transition">
                                        Stretch
                                    </div>
                                </label>
                                <label class="cursor-pointer">
                                    <input type="radio" name="reflection" value="Impossible" class="peer sr-only">
                                    <div class="p-3 text-center border rounded-md hover:bg-gray-50 peer-checked:border-primary peer-checked:bg-blue-50 peer-checked:text-primary transition">
                                        Ambitious
                                    </div>
                                </label>
                            </div>
                            <p id="err-reflection" class="error-text mt-2">Please select how this feels.</p>
                        </div>
                    </div>

                    <div id="step-4" class="step-content hidden">
                        <div class="guide-box">
                            <h3 class="font-bold mb-1">YOUR GUIDE: The Action Plan</h3>
                            <p>The math showed us the "What." Now we decide the "How." Please commit to one specific action for each pillar to close your gap.</p>
                        </div>

                        <div class="space-y-6">
                            <div>
                                <label class="input-label">
                                    Action 1: People (Training & Coaching)
                                    <div class="tooltip-container"><span class="tooltip-trigger">?</span><div class="tooltip-popup">What skill will you improve? e.g., "Complete Negotiation Certification." (Reference Team Selling Best Practice Session)</div></div>
                                </label>
                                <input type="text" id="act-people" class="input-field required" placeholder="I will...">
                                <p class="error-text">Please add a People action.</p>
                            </div>

                            <div>
                                <label class="input-label">
                                    Action 2: Process (Pipeline & Quality)
                                    <div class="tooltip-container"><span class="tooltip-trigger">?</span><div class="tooltip-popup">How will you improve deal quality? e.g., "Disqualify bad deals earlier." (Reference Account Planning Best Practice Session)</div></div>
                                </label>
                                <input type="text" id="act-process" class="input-field required" placeholder="I will...">
                                <p class="error-text">Please add a Process action.</p>
                            </div>

                            <div>
                                <label class="input-label">
                                    Action 3: Productivity (Time & Tools)
                                    <div class="tooltip-container"><span class="tooltip-trigger">?</span><div class="tooltip-popup">How will you work smarter? e.g., "Block 2 hours daily for prospecting."</div></div>
                                </label>
                                <input type="text" id="act-prod" class="input-field required" placeholder="I will...">
                                <p class="error-text">Please add a Productivity action.</p>
                            </div>

                            <div class="pt-6 border-t">
                                <label class="input-label">
                                    My Accuracy Commitment
                                    <div class="tooltip-container"><span class="tooltip-trigger">?</span><div class="tooltip-popup">How will you ensure your forecast is accurate?</div></div>
                                </label>
                                <p class="text-xs text-gray-500 mb-2">"My Rep Commit will be 95-105% accurate every quarter."</p>
                                <input type="text" id="act-forecast" class="input-field required" placeholder="Key action to ensure accuracy...">
                                <p class="error-text">Please add your commitment.</p>
                            </div>
                        </div>
                    </div>

                    <div id="step-5" class="step-content hidden">
                        <div class="guide-box">
                            <h3 class="font-bold mb-1">YOUR GUIDE: Final Commitment</h3>
                            <p>Review your plan below. This is your roadmap for 2026. Please export the data for your manager and save a PDF copy for yourself.</p>
                        </div>

                        <div id="summary-display" class="bg-gray-50 p-6 rounded-lg text-sm text-gray-700 font-mono whitespace-pre-wrap border border-gray-200 h-96 overflow-y-auto shadow-inner">
                            </div>
                    </div>

                </form>
            </div>

            <div id="nav-area" class="p-6 border-t bg-gray-50 flex justify-between items-center rounded-b-xl">
                <button id="btn-prev" class="btn btn-ghost hidden">‚Üê Back</button>
                <div class="flex-grow"></div>
                
                <div id="final-buttons" class="hidden flex gap-3">
                    <button id="btn-restart" class="btn btn-ghost text-red-600 hover:bg-red-50">Start Over</button>
                    <button id="btn-pdf" class="btn btn-ghost border border-gray-300 bg-white">Save PDF</button>
                    <button id="btn-copy" class="btn btn-primary">Copy Text</button>
                    <button id="btn-json" class="btn btn-accent">Export Data</button>
                </div>

                <button id="btn-next" class="btn btn-primary min-w-[120px] shadow-lg">Start</button>
            </div>

        </div>
    </div>

<script>
    // --- DATA & CONFIG ---
    const ROLE_DATA = {
        'AE': {
            lbl: {
                q25: '2025 Quota ($)', q25tip: 'Your total assigned revenue quota for 2025.',
                a25: '2025 Bookings ($)', a25tip: 'Your total closed/booked revenue for the year.',
                e25: 'Win Rate %', e25tip: 'The percentage of opportunities you won.',
                d25: 'Avg Deal Size ($)', d25tip: 'Your average dollar value per closed deal.',
                q26: '2026 Quota ($)',
                resA: 'Pipeline Needed',
                resB: 'Deals Needed'
            },
            isMoney: true,
            docs: ["2025 Quota & Bookings", "Win Rate %", "Average Deal Size"]
        },
        'SDR': {
            lbl: {
                q25: '2025 Target (#)', q25tip: 'Your target number of Meetings or SQLs.',
                a25: '2025 Actuals (#)', a25tip: 'The actual number of Meetings/SQLs you achieved.',
                e25: 'Conversion %', e25tip: 'Your conversion rate from Lead to Meeting.',
                d25: 'Avg Opp Size ($)', d25tip: 'Optional: The average size of opps you generate.',
                q26: '2026 Target (#)',
                resA: 'Activity Volume Needed',
                resB: 'Est. Pipeline Generated'
            },
            isMoney: false,
            docs: ["2025 Activity/Meeting Targets", "Conversion Rates", "2026 Target"]
        },
        'SE': {
             lbl: {
                q25: '2025 Rev Target ($)', q25tip: 'The total revenue target you supported.',
                a25: '2025 Actuals ($)', a25tip: 'The actual revenue closed that you supported.',
                e25: 'Tech Win Rate %', e25tip: 'Percentage of deals where you secured the Technical Win.',
                d25: 'Avg Deal Size ($)', d25tip: 'The average size of deals you support.',
                q26: '2026 Rev Target ($)',
                resA: 'Coverage Needed',
                resB: 'Deals to Support'
            },
            isMoney: true,
            docs: ["2025 Supported Revenue", "Technical Win Rate", "2026 Revenue Target"]
        },
        'ECOMM': {
             lbl: {
                q25: '2025 Revenue ($)', q25tip: 'Total eCommerce revenue target.',
                a25: '2025 Actuals ($)', a25tip: 'Total revenue actually achieved.',
                e25: 'Conversion Rate %', e25tip: 'Website visitor to purchaser conversion rate.',
                d25: 'Avg Order Value ($)', d25tip: 'Average dollar value per transaction.',
                q26: '2026 Revenue ($)',
                resA: 'Traffic/Leads Needed',
                resB: 'Transactions Needed'
            },
            isMoney: true,
            docs: ["2025 Revenue & Actuals", "Site Conversion Rate", "Average Order Value"]
        },
        'COMPLIANCE': {
            lbl: {
                q25: '2025 Objectives', q25tip: 'Total count of key objectives.',
                a25: 'Completed', a25tip: 'Number of objectives completed.',
                e25: 'Completion %', e25tip: 'Percentage of objectives completed.',
                d25: 'N/A', d25tip: 'Not applicable. Enter 0.',
                q26: '2026 Objectives',
                resA: 'Gap',
                resB: 'Notes'
            },
            isMoney: false,
            skipMath: true,
            docs: ["2025 Key Objectives List", "2026 Goals/Projects"]
        }
    };

    const $ = (id) => document.getElementById(id);
    const getVal = (id) => parseFloat($(id).value.replace(/,/g, '')) || 0;
    const setTxt = (id, txt) => { if($(id)) $(id).textContent = txt; };
    const fmt$ = (n) => '$' + n.toLocaleString('en-US', {maximumFractionDigits:0});
    const fmtN = (n) => n.toLocaleString('en-US', {maximumFractionDigits:1});

    // --- APP LOGIC ---
    let step = 0; 
    const maxStep = 5;

    function updateLabels() {
        const r = $('userRole').value;
        const data = ROLE_DATA[r];
        
        // Update Labels & Tooltips
        setTxt('lbl-quota25', data.lbl.q25); $('tip-quota25').textContent = data.lbl.q25tip;
        setTxt('lbl-actual25', data.lbl.a25); $('tip-actual25').textContent = data.lbl.a25tip;
        setTxt('lbl-efficiency25', data.lbl.e25); $('tip-efficiency25').textContent = data.lbl.e25tip;
        setTxt('lbl-dealSize25', data.lbl.d25); $('tip-dealSize25').textContent = data.lbl.d25tip;
        setTxt('lbl-quota26', data.lbl.q26); $('tip-quota26').textContent = data.lbl.q26tip || 'Your new target for the coming year.';
        setTxt('lbl-resultA', data.lbl.resA);
        setTxt('lbl-resultB', data.lbl.resB);

        // Update "What You Need" list dynamically on Step 1
        const docList = $('dynamic-req-list');
        docList.innerHTML = '';
        data.docs.forEach(doc => {
            const li = document.createElement('li');
            li.textContent = doc;
            docList.appendChild(li);
        });

        // Handle Compliance special case
        const isComp = (r === 'COMPLIANCE');
        $('calc-section').style.display = isComp ? 'none' : 'block';
    }

    function doMath() {
        const r = $('userRole').value;
        const conf = ROLE_DATA[r];

        const q25 = getVal('val-quota25');
        const a25 = getVal('val-actual25');
        
        // Attainment
        const att = q25 > 0 ? (a25 / q25) * 100 : 0;
        setTxt('calc-attainment', att.toFixed(1) + '%');

        if(conf.skipMath) {
            setTxt('calc-resultA', "N/A");
            setTxt('calc-resultB', "N/A");
            return;
        }

        const eff = getVal('val-efficiency25') / 100;
        const size = getVal('val-dealSize25');
        const q26 = getVal('val-quota26');

        // Calc A: "Pipeline/Volume Needed" = Target / Efficiency
        const valA = eff > 0 ? q26 / eff : 0;
        
        // Calc B: "Deals/Trans Needed"
        let valB = 0;
        if(size > 0) {
            valB = valA / size; 
        } else {
            valB = valA; 
        }

        setTxt('calc-resultA', conf.isMoney ? fmt$(valA) : fmtN(valA));
        setTxt('calc-resultB', fmtN(valB));
    }

    function validate() {
        let valid = true;
        const currentPanel = $(`step-${step}`);
        
        const inputs = Array.from(currentPanel.querySelectorAll('.required')).filter(el => {
             // CRITICAL FIX: Only validate visible elements (to skip hidden compliance math fields)
            return el.offsetParent !== null;
        });
        
        inputs.forEach(inp => {
            const err = inp.nextElementSibling;
            if(!inp.value.trim()) {
                inp.classList.add('input-error');
                if(err && err.classList.contains('error-text')) err.classList.add('show');
                valid = false;
            } else {
                inp.classList.remove('input-error');
                if(err) err.classList.remove('show');
            }
        });

        // Radio Check (Step 3 only)
        if(step === 3 && $('userRole').value !== 'COMPLIANCE') {
            const checked = document.querySelector('input[name="reflection"]:checked');
            const err = $('err-reflection');
            if(!checked) {
                err.classList.add('show');
                valid = false;
            } else {
                err.classList.remove('show');
            }
        }

        return valid;
    }

    function generateSummary() {
        return `TRIMBLE 2026 SUCCESS PLAN
---------------------------
Name: ${$('personName').value}
Role: ${$('userRole').value}
Region: ${$('region').value}

BASELINE (2025)
- Target: ${$('val-quota25').value}
- Actual: ${$('val-actual25').value}
- Attainment: ${$('calc-attainment').textContent}
- Efficiency: ${$('val-efficiency25').value}%

2026 GOALS
- New Target: ${$('val-quota26').value}
- Required Volume: ${$('calc-resultA').textContent}
- Reflection: ${document.querySelector('input[name="reflection"]:checked')?.value || 'N/A'}

ACTION PLAN
1. People: ${$('act-people').value}
2. Process: ${$('act-process').value}
3. Productivity: ${$('act-prod').value}
4. Accuracy: ${$('act-forecast').value}
`;
    }

    function navigate(dir) {
        if(dir === 1 && !validate()) return;

        // Hide current
        $(`step-${step}`).classList.add('hidden');
        
        step += dir;

        // Show new
        $(`step-${step}`).classList.remove('hidden');

        // Update UI
        const isStart = (step === 0);
        const isFinal = (step === maxStep);

        // Progress Bar
        $('progress-bar').style.display = (step >= 2) ? 'flex' : 'none';
        if(step >= 2) {
            ['baseline','gap','solution','review'].forEach((id, i) => {
                const el = $(`tab-${id}`);
                el.className = 'progress-step';
                if(i + 2 === step) el.classList.add('active'); // current
                if(i + 2 < step) el.classList.add('completed'); // past
            });
        }

        // Nav Buttons
        const nextBtn = $('btn-next');
        const prevBtn = $('btn-prev');
        const navArea = $('nav-area');
        const finalBtns = $('final-buttons');

        if(isStart) {
            prevBtn.classList.add('hidden');
            nextBtn.textContent = 'Start';
            navArea.classList.add('justify-center'); // Center button on welcome
        } else {
            prevBtn.classList.remove('hidden');
            navArea.classList.remove('justify-center');
        }

        if(step === 1) nextBtn.textContent = 'Next';
        
        if(isFinal) {
            nextBtn.classList.add('hidden');
            finalBtns.classList.remove('hidden');
            $('summary-display').textContent = generateSummary();
        } else {
            nextBtn.classList.remove('hidden');
            finalBtns.classList.add('hidden');
        }

        // Run updates for context
        if (step === 1) {
            updateLabels(); // Forces the labels/list to populate when visible
        }

        // Scroll to top
        window.scrollTo(0,0);
    }

    // --- EVENT LISTENERS ---
    $('btn-next').onclick = () => navigate(1);
    $('btn-prev').onclick = () => navigate(-1);
    
    // Live Math & Role Updates
    $('userRole').onchange = () => { updateLabels(); doMath(); };
    document.querySelectorAll('input').forEach(i => {
        i.oninput = doMath;
    });

    // Final Buttons
    $('btn-restart').onclick = () => {
        if(confirm("Start over?")) location.reload();
    };
    $('btn-copy').onclick = () => {
        navigator.clipboard.writeText($('summary-display').textContent);
        alert("Copied to clipboard!");
    };
    $('btn-pdf').onclick = () => window.print();
    $('btn-json').onclick = () => {
        const data = {
            user: $('personName').value,
            role: $('userRole').value,
            date: new Date().toISOString(),
            plan: $('summary-display').textContent
        };
        const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'trimble-plan.json';
        a.click();
    };

    // Init
    updateLabels();
</script>

</body>
</html>
